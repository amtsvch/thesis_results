/**                                                                                                    /**                                                                                                 
* Merge the supplied web fragments into this main web.xml.                                             * Merge the supplied web fragments into this main web.xml.                                          
*                                                                                                      *                                                                                                   
* @param fragments     The fragments to merge in                                                       * @param fragments     The fragments to merge in                                                    
* @return &lt;code&gt;true&lt;/code&gt; if merge is successful, else                                   * @return &lt;code&gt;true&lt;/code&gt; if merge is successful, else                                
*         &lt;code&gt;false&lt;/code&gt;                                                               *         &lt;code&gt;false&lt;/code&gt;                                                            
*/                                                                                                     */                                                                                                  
public boolean merge(Set&lt;WebXml&gt; fragments) {                                                    public boolean merge(Set&lt;WebXml&gt; fragments) {                                                 
// As far as possible, process in alphabetical order so it is easy to                                  // As far as possible, process in alphabetical order so it is easy to                               
// check everything is present                                                                         // check everything is present                                                                      
// Merge rules vary from element to element. See SRV.8.2.3                                             // Merge rules vary from element to element. See SRV.8.2.3                                          
WebXml temp = new WebXml();                                                                            WebXml temp = new WebXml();                                                                         
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (!mergeMap(fragment.getContextParams(), contextParams, temp.getContextParams(), fragment, "Contex   if (!mergeMap(fragment.getContextParams(), contextParams, temp.getContextParams(), fragment, "Contex
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
contextParams.putAll(temp.getContextParams());                                                         contextParams.putAll(temp.getContextParams());                                                      
if (displayName == null) {                                                                             if (displayName == null) {                                                                          
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
String value = fragment.getDisplayName();                                                              String value = fragment.getDisplayName();                                                           
if (value != null) {                                                                                   if (value != null) {                                                                                
if (temp.getDisplayName() == null) {                                                                   if (temp.getDisplayName() == null) {                                                                
temp.setDisplayName(value);                                                                            temp.setDisplayName(value);                                                                         
} else {                                                                                               } else {                                                                                            
log.error(sm.getString("webXml.mergeConflictDisplayName", fragment.getName(), fragment.getURL()));     log.error(sm.getString("webXml.mergeConflictDisplayName", fragment.getName(), fragment.getURL()));  
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
displayName = temp.getDisplayName();                                                                   displayName = temp.getDisplayName();                                                                
}                                                                                                      }                                                                                                   
// Note: Not permitted in fragments but we also use fragments for                                      // Note: Not permitted in fragments but we also use fragments for                                   
// per-Host and global defaults so they may appear there                                               // per-Host and global defaults so they may appear there                                            
if (!denyUncoveredHttpMethods) {                                                                       if (!denyUncoveredHttpMethods) {                                                                    
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (fragment.getDenyUncoveredHttpMethods()) {                                                          if (fragment.getDenyUncoveredHttpMethods()) {                                                       
denyUncoveredHttpMethods = true;                                                                       denyUncoveredHttpMethods = true;                                                                    
break;                                                                                                 break;                                                                                              
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
if (requestCharacterEncoding == null) {                                                                if (requestCharacterEncoding == null) {                                                             
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (fragment.getRequestCharacterEncoding() != null) {                                                  if (fragment.getRequestCharacterEncoding() != null) {                                               
requestCharacterEncoding = fragment.getRequestCharacterEncoding();                                     requestCharacterEncoding = fragment.getRequestCharacterEncoding();                                  
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
if (responseCharacterEncoding == null) {                                                               if (responseCharacterEncoding == null) {                                                            
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (fragment.getResponseCharacterEncoding() != null) {                                                 if (fragment.getResponseCharacterEncoding() != null) {                                              
responseCharacterEncoding = fragment.getResponseCharacterEncoding();                                   responseCharacterEncoding = fragment.getResponseCharacterEncoding();                                
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
if (distributable) {                                                                                   if (distributable) {                                                                                
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (!fragment.isDistributable()) {                                                                     if (!fragment.isDistributable()) {                                                                  
distributable = false;                                                                                 distributable = false;                                                                              
break;                                                                                                 break;                                                                                              
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (!mergeResourceMap(fragment.getEjbLocalRefs(), ejbLocalRefs, temp.getEjbLocalRefs(), fragment)) {   if (!mergeResourceMap(fragment.getEjbLocalRefs(), ejbLocalRefs, temp.getEjbLocalRefs(), fragment)) {
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
ejbLocalRefs.putAll(temp.getEjbLocalRefs());                                                           ejbLocalRefs.putAll(temp.getEjbLocalRefs());                                                        
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (!mergeResourceMap(fragment.getEjbRefs(), ejbRefs, temp.getEjbRefs(), fragment)) {                  if (!mergeResourceMap(fragment.getEjbRefs(), ejbRefs, temp.getEjbRefs(), fragment)) {               
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
ejbRefs.putAll(temp.getEjbRefs());                                                                     ejbRefs.putAll(temp.getEjbRefs());                                                                  
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (!mergeResourceMap(fragment.getEnvEntries(), envEntries, temp.getEnvEntries(), fragment)) {         if (!mergeResourceMap(fragment.getEnvEntries(), envEntries, temp.getEnvEntries(), fragment)) {      
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
envEntries.putAll(temp.getEnvEntries());                                                               envEntries.putAll(temp.getEnvEntries());                                                            
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (!mergeMap(fragment.getErrorPages(), errorPages, temp.getErrorPages(), fragment, "Error Page")) {   if (!mergeMap(fragment.getErrorPages(), errorPages, temp.getErrorPages(), fragment, "Error Page")) {
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
errorPages.putAll(temp.getErrorPages());                                                               errorPages.putAll(temp.getErrorPages());                                                            
// As per 'clarification' from the Servlet EG, filter definitions in the                               // As per 'clarification' from the Servlet EG, filter definitions in the                            
// main web.xml override those in fragments and those in fragments                                     // main web.xml override those in fragments and those in fragments                                  
// override those in annotations                                                                       // override those in annotations                                                                    
List&lt;FilterMap&gt; filterMapsToAdd = new ArrayList&lt;&gt;();                                       List&lt;FilterMap&gt; filterMapsToAdd = new ArrayList&lt;&gt;();                                    
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
for (FilterMap filterMap : fragment.getFilterMappings()) {                                             for (FilterMap filterMap : fragment.getFilterMappings()) {                                          
if (!filterMappingNames.contains(filterMap.getFilterName())) {                                         if (!filterMappingNames.contains(filterMap.getFilterName())) {                                      
filterMapsToAdd.add(filterMap);                                                                        filterMapsToAdd.add(filterMap);                                                                     
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
for (FilterMap filterMap : filterMapsToAdd) {                                                          for (FilterMap filterMap : filterMapsToAdd) {                                                       
// Additive                                                                                            // Additive                                                                                         
addFilterMapping(filterMap);                                                                           addFilterMapping(filterMap);                                                                        
}                                                                                                      }                                                                                                   
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
for (Map.Entry&lt;String, FilterDef&gt; entry : fragment.getFilters().entrySet()) {                    for (Map.Entry&lt;String, FilterDef&gt; entry : fragment.getFilters().entrySet()) {                 
if (filters.containsKey(entry.getKey())) {                                                             if (filters.containsKey(entry.getKey())) {                                                          
mergeFilter(entry.getValue(), filters.get(entry.getKey()), false);                                     mergeFilter(entry.getValue(), filters.get(entry.getKey()), false);                                  
} else {                                                                                               } else {                                                                                            
if (temp.getFilters().containsKey(entry.getKey())) {                                                   if (temp.getFilters().containsKey(entry.getKey())) {                                                
if (!(mergeFilter(entry.getValue(), temp.getFilters().get(entry.getKey()), true))) {                   if (!(mergeFilter(entry.getValue(), temp.getFilters().get(entry.getKey()), true))) {                
log.error(sm.getString("webXml.mergeConflictFilter", entry.getKey(), fragment.getName(), fragment.ge   log.error(sm.getString("webXml.mergeConflictFilter", entry.getKey(), fragment.getName(), fragment.ge
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
} else {                                                                                               } else {                                                                                            
temp.getFilters().put(entry.getKey(), entry.getValue());                                               temp.getFilters().put(entry.getKey(), entry.getValue());                                            
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
filters.putAll(temp.getFilters());                                                                     filters.putAll(temp.getFilters());                                                                  
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
for (JspPropertyGroup jspPropertyGroup : fragment.getJspPropertyGroups()) {                            for (JspPropertyGroup jspPropertyGroup : fragment.getJspPropertyGroups()) {                         
// Always additive                                                                                     // Always additive                                                                                  
addJspPropertyGroup(jspPropertyGroup);                                                                 addJspPropertyGroup(jspPropertyGroup);                                                              
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
for (String listener : fragment.getListeners()) {                                                      for (String listener : fragment.getListeners()) {                                                   
// Always additive                                                                                     // Always additive                                                                                  
addListener(listener);                                                                                 addListener(listener);                                                                              
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (!mergeMap(fragment.getLocaleEncodingMappings(), localeEncodingMappings, temp.getLocaleEncodingMa   if (!mergeMap(fragment.getLocaleEncodingMappings(), localeEncodingMappings, temp.getLocaleEncodingMa
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
localeEncodingMappings.putAll(temp.getLocaleEncodingMappings());                                       localeEncodingMappings.putAll(temp.getLocaleEncodingMappings());                                    
if (getLoginConfig() == null) {                                                                        if (getLoginConfig() == null) {                                                                     
LoginConfig tempLoginConfig = null;                                                                    LoginConfig tempLoginConfig = null;                                                                 
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
LoginConfig fragmentLoginConfig = fragment.loginConfig;                                                LoginConfig fragmentLoginConfig = fragment.loginConfig;                                             
if (fragmentLoginConfig != null) {                                                                     if (fragmentLoginConfig != null) {                                                                  
if (tempLoginConfig == null || fragmentLoginConfig.equals(tempLoginConfig)) {                          if (tempLoginConfig == null || fragmentLoginConfig.equals(tempLoginConfig)) {                       
tempLoginConfig = fragmentLoginConfig;                                                                 tempLoginConfig = fragmentLoginConfig;                                                              
} else {                                                                                               } else {                                                                                            
log.error(sm.getString("webXml.mergeConflictLoginConfig", fragment.getName(), fragment.getURL()));     log.error(sm.getString("webXml.mergeConflictLoginConfig", fragment.getName(), fragment.getURL()));  
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
loginConfig = tempLoginConfig;                                                                         loginConfig = tempLoginConfig;                                                                      
}                                                                                                      }                                                                                                   
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (!mergeResourceMap(fragment.getMessageDestinationRefs(), messageDestinationRefs, temp.getMessageD   if (!mergeResourceMap(fragment.getMessageDestinationRefs(), messageDestinationRefs, temp.getMessageD
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
messageDestinationRefs.putAll(temp.getMessageDestinationRefs());                                       messageDestinationRefs.putAll(temp.getMessageDestinationRefs());                                    
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (!mergeResourceMap(fragment.getMessageDestinations(), messageDestinations, temp.getMessageDestina   if (!mergeResourceMap(fragment.getMessageDestinations(), messageDestinations, temp.getMessageDestina
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
messageDestinations.putAll(temp.getMessageDestinations());                                             messageDestinations.putAll(temp.getMessageDestinations());                                          
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (!mergeMap(fragment.getMimeMappings(), mimeMappings, temp.getMimeMappings(), fragment, "Mime Mapp   if (!mergeMap(fragment.getMimeMappings(), mimeMappings, temp.getMimeMappings(), fragment, "Mime Mapp
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
mimeMappings.putAll(temp.getMimeMappings());                                                           mimeMappings.putAll(temp.getMimeMappings());                                                        
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (!mergeResourceMap(fragment.getResourceEnvRefs(), resourceEnvRefs, temp.getResourceEnvRefs(), fra   if (!mergeResourceMap(fragment.getResourceEnvRefs(), resourceEnvRefs, temp.getResourceEnvRefs(), fra
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
resourceEnvRefs.putAll(temp.getResourceEnvRefs());                                                     resourceEnvRefs.putAll(temp.getResourceEnvRefs());                                                  
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (!mergeResourceMap(fragment.getResourceRefs(), resourceRefs, temp.getResourceRefs(), fragment)) {   if (!mergeResourceMap(fragment.getResourceRefs(), resourceRefs, temp.getResourceRefs(), fragment)) {
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
resourceRefs.putAll(temp.getResourceRefs());                                                           resourceRefs.putAll(temp.getResourceRefs());                                                        
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
for (SecurityConstraint constraint : fragment.getSecurityConstraints()) {                              for (SecurityConstraint constraint : fragment.getSecurityConstraints()) {                           
// Always additive                                                                                     // Always additive                                                                                  
addSecurityConstraint(constraint);                                                                     addSecurityConstraint(constraint);                                                                  
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
for (String role : fragment.getSecurityRoles()) {                                                      for (String role : fragment.getSecurityRoles()) {                                                   
// Always additive                                                                                     // Always additive                                                                                  
addSecurityRole(role);                                                                                 addSecurityRole(role);                                                                              
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (!mergeResourceMap(fragment.getServiceRefs(), serviceRefs, temp.getServiceRefs(), fragment)) {      if (!mergeResourceMap(fragment.getServiceRefs(), serviceRefs, temp.getServiceRefs(), fragment)) {   
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
serviceRefs.putAll(temp.getServiceRefs());                                                             serviceRefs.putAll(temp.getServiceRefs());                                                          
// As per 'clarification' from the Servlet EG, servlet definitions and                                 // As per 'clarification' from the Servlet EG, servlet definitions and                              
// mappings in the main web.xml override those in fragments and those in                               // mappings in the main web.xml override those in fragments and those in                            
// fragments override those in annotations                                                             // fragments override those in annotations                                                          
// Skip servlet definitions and mappings from fragments that are                                       // Skip servlet definitions and mappings from fragments that are                                    
// defined in web.xml                                                                                  // defined in web.xml                                                                               
List&lt;Map.Entry&lt;String, String&gt;&gt; servletMappingsToAdd = new ArrayList&lt;&gt;();            List&lt;Map.Entry&lt;String, String&gt;&gt; servletMappingsToAdd = new ArrayList&lt;&gt;();         
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
for (Map.Entry&lt;String, String&gt; servletMap : fragment.getServletMappings().entrySet()) {          for (Map.Entry&lt;String, String&gt; servletMap : fragment.getServletMappings().entrySet()) {       
if (!servletMappingNames.contains(servletMap.getValue()) && !servletMappings.containsKey(servletMap.   if (!servletMappingNames.contains(servletMap.getValue()) && !servletMappings.containsKey(servletMap.
servletMappingsToAdd.add(servletMap);                                                                  servletMappingsToAdd.add(servletMap);                                                               
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
// Add fragment mappings                                                                               // Add fragment mappings                                                                            
for (Map.Entry&lt;String, String&gt; mapping : servletMappingsToAdd) {                                 for (Map.Entry&lt;String, String&gt; mapping : servletMappingsToAdd) {                              
addServletMappingDecoded(mapping.getKey(), mapping.getValue());                                        addServletMappingDecoded(mapping.getKey(), mapping.getValue());                                     
}                                                                                                      }                                                                                                   
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
for (Map.Entry&lt;String, ServletDef&gt; entry : fragment.getServlets().entrySet()) {                  for (Map.Entry&lt;String, ServletDef&gt; entry : fragment.getServlets().entrySet()) {               
if (servlets.containsKey(entry.getKey())) {                                                            if (servlets.containsKey(entry.getKey())) {                                                         
mergeServlet(entry.getValue(), servlets.get(entry.getKey()), false);                                   mergeServlet(entry.getValue(), servlets.get(entry.getKey()), false);                                
} else {                                                                                               } else {                                                                                            
if (temp.getServlets().containsKey(entry.getKey())) {                                                  if (temp.getServlets().containsKey(entry.getKey())) {                                               
if (!(mergeServlet(entry.getValue(), temp.getServlets().get(entry.getKey()), true))) {                 if (!(mergeServlet(entry.getValue(), temp.getServlets().get(entry.getKey()), true))) {              
log.error(sm.getString("webXml.mergeConflictServlet", entry.getKey(), fragment.getName(), fragment.g   log.error(sm.getString("webXml.mergeConflictServlet", entry.getKey(), fragment.getName(), fragment.g
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
} else {                                                                                               } else {                                                                                            
temp.getServlets().put(entry.getKey(), entry.getValue());                                              temp.getServlets().put(entry.getKey(), entry.getValue());                                           
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
servlets.putAll(temp.getServlets());                                                                   servlets.putAll(temp.getServlets());                                                                
if (sessionConfig.getSessionTimeout() == null) {                                                       if (sessionConfig.getSessionTimeout() == null) {                                                    
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
Integer value = fragment.getSessionConfig().getSessionTimeout();                                       Integer value = fragment.getSessionConfig().getSessionTimeout();                                    
if (value != null) {                                                                                   if (value != null) {                                                                                
if (temp.getSessionConfig().getSessionTimeout() == null) {                                             if (temp.getSessionConfig().getSessionTimeout() == null) {                                          
temp.getSessionConfig().setSessionTimeout(value.toString());                                           temp.getSessionConfig().setSessionTimeout(value.toString());                                        
} else if (value.equals(temp.getSessionConfig().getSessionTimeout())) {                                } else if (value.equals(temp.getSessionConfig().getSessionTimeout())) {                             
// Fragments use same value - no conflict                                                              // Fragments use same value - no conflict                                                           
} else {                                                                                               } else {                                                                                            
log.error(sm.getString("webXml.mergeConflictSessionTimeout", fragment.getName(), fragment.getURL()))   log.error(sm.getString("webXml.mergeConflictSessionTimeout", fragment.getName(), fragment.getURL()))
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
if (temp.getSessionConfig().getSessionTimeout() != null) {                                             if (temp.getSessionConfig().getSessionTimeout() != null) {                                          
sessionConfig.setSessionTimeout(temp.getSessionConfig().getSessionTimeout().toString());               sessionConfig.setSessionTimeout(temp.getSessionConfig().getSessionTimeout().toString());            
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
if (sessionConfig.getCookieName() == null) {                                                           if (sessionConfig.getCookieName() == null) {                                                        
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
String value = fragment.getSessionConfig().getCookieName();                                            String value = fragment.getSessionConfig().getCookieName();                                         
if (value != null) {                                                                                   if (value != null) {                                                                                
if (temp.getSessionConfig().getCookieName() == null) {                                                 if (temp.getSessionConfig().getCookieName() == null) {                                              
temp.getSessionConfig().setCookieName(value);                                                          temp.getSessionConfig().setCookieName(value);                                                       
} else if (value.equals(temp.getSessionConfig().getCookieName())) {                                    } else if (value.equals(temp.getSessionConfig().getCookieName())) {                                 
// Fragments use same value - no conflict                                                              // Fragments use same value - no conflict                                                           
} else {                                                                                               } else {                                                                                            
log.error(sm.getString("webXml.mergeConflictSessionCookieName", fragment.getName(), fragment.getURL(   log.error(sm.getString("webXml.mergeConflictSessionCookieName", fragment.getName(), fragment.getURL(
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
sessionConfig.setCookieName(temp.getSessionConfig().getCookieName());                                  sessionConfig.setCookieName(temp.getSessionConfig().getCookieName());                               
}                                                                                                      }                                                                                                   
if (sessionConfig.getCookieDomain() == null) {                                                       | Map&lt;String, String&gt; mainAttributes = getSessionConfig().getCookieAttributes();                
                                                                                                     | Map&lt;String, String&gt; mergedFragmentAttributes = new TreeMap&lt;&gt;(String.CASE_INSENSITIVE_ORD
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
String value = fragment.getSessionConfig().getCookieDomain();                                        | for (Map.Entry&lt;String, String&gt; attribute : fragment.getSessionConfig().getCookieAttributes().e
if (value != null) {                                                                                 | // Skip any attribute in a fragment that is defined in the main web.xml                             
if (temp.getSessionConfig().getCookieDomain() == null) {                                             | if (!mainAttributes.containsKey(attribute.getKey())) {                                              
temp.getSessionConfig().setCookieDomain(value);                                                      | if (mergedFragmentAttributes.containsKey(attribute.getKey())) {                                     
} else if (value.equals(temp.getSessionConfig().getCookieDomain())) {                                | // Attribute has already been seen.                                                                 
// Fragments use same value - no conflict                                                            | // If values are the same, NO-OP. If they are different                                             
} else {                                                                                             | // trigger a merge error                                                                            
log.error(sm.getString("webXml.mergeConflictSessionCookieDomain", fragment.getName(), fragment.getUR | if (!mergedFragmentAttributes.get(attribute.getKey()).equals(attribute.getValue())) {               
                                                                                                     | log.error(sm.getString("webXml.mergeConflictSessionCookieAttributes", fragment.getName(), fragment.g
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                    |                                                                                                     
}                                                                                                    |                                                                                                     
sessionConfig.setCookieDomain(temp.getSessionConfig().getCookieDomain());                            |                                                                                                     
}                                                                                                    |                                                                                                     
if (sessionConfig.getCookiePath() == null) {                                                         |                                                                                                     
for (WebXml fragment : fragments) {                                                                  |                                                                                                     
String value = fragment.getSessionConfig().getCookiePath();                                          |                                                                                                     
if (value != null) {                                                                                 |                                                                                                     
if (temp.getSessionConfig().getCookiePath() == null) {                                               |                                                                                                     
temp.getSessionConfig().setCookiePath(value);                                                        |                                                                                                     
} else if (value.equals(temp.getSessionConfig().getCookiePath())) {                                  |                                                                                                     
// Fragments use same value - no conflict                                                            |                                                                                                     
} else {                                                                                               } else {                                                                                            
log.error(sm.getString("webXml.mergeConflictSessionCookiePath", fragment.getName(), fragment.getURL( | // First time this attribute has been seen. Add it.                                                 
return false;                                                                                        | mergedFragmentAttributes.put(attribute.getKey(), attribute.getValue());                             
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
sessionConfig.setCookiePath(temp.getSessionConfig().getCookiePath());                                |                                                                                                     
}                                                                                                      }                                                                                                   
if (sessionConfig.getCookieComment() == null) {                                                      | mainAttributes.putAll(mergedFragmentAttributes);                                                    
for (WebXml fragment : fragments) {                                                                  |                                                                                                     
String value = fragment.getSessionConfig().getCookieComment();                                       |                                                                                                     
if (value != null) {                                                                                 |                                                                                                     
if (temp.getSessionConfig().getCookieComment() == null) {                                            |                                                                                                     
temp.getSessionConfig().setCookieComment(value);                                                     |                                                                                                     
} else if (value.equals(temp.getSessionConfig().getCookieComment())) {                               |                                                                                                     
// Fragments use same value - no conflict                                                            |                                                                                                     
} else {                                                                                             |                                                                                                     
log.error(sm.getString("webXml.mergeConflictSessionCookieComment", fragment.getName(), fragment.getU |                                                                                                     
return false;                                                                                        |                                                                                                     
}                                                                                                    |                                                                                                     
}                                                                                                    |                                                                                                     
}                                                                                                    |                                                                                                     
sessionConfig.setCookieComment(temp.getSessionConfig().getCookieComment());                          |                                                                                                     
}                                                                                                    |                                                                                                     
if (sessionConfig.getCookieHttpOnly() == null) {                                                     |                                                                                                     
for (WebXml fragment : fragments) {                                                                  |                                                                                                     
Boolean value = fragment.getSessionConfig().getCookieHttpOnly();                                     |                                                                                                     
if (value != null) {                                                                                 |                                                                                                     
if (temp.getSessionConfig().getCookieHttpOnly() == null) {                                           |                                                                                                     
temp.getSessionConfig().setCookieHttpOnly(value.toString());                                         |                                                                                                     
} else if (value.equals(temp.getSessionConfig().getCookieHttpOnly())) {                              |                                                                                                     
// Fragments use same value - no conflict                                                            |                                                                                                     
} else {                                                                                             |                                                                                                     
log.error(sm.getString("webXml.mergeConflictSessionCookieHttpOnly", fragment.getName(), fragment.get |                                                                                                     
return false;                                                                                        |                                                                                                     
}                                                                                                    |                                                                                                     
}                                                                                                    |                                                                                                     
}                                                                                                    |                                                                                                     
if (temp.getSessionConfig().getCookieHttpOnly() != null) {                                           |                                                                                                     
sessionConfig.setCookieHttpOnly(temp.getSessionConfig().getCookieHttpOnly().toString());             |                                                                                                     
}                                                                                                    |                                                                                                     
}                                                                                                    |                                                                                                     
if (sessionConfig.getCookieSecure() == null) {                                                       |                                                                                                     
for (WebXml fragment : fragments) {                                                                  |                                                                                                     
Boolean value = fragment.getSessionConfig().getCookieSecure();                                       |                                                                                                     
if (value != null) {                                                                                 |                                                                                                     
if (temp.getSessionConfig().getCookieSecure() == null) {                                             |                                                                                                     
temp.getSessionConfig().setCookieSecure(value.toString());                                           |                                                                                                     
} else if (value.equals(temp.getSessionConfig().getCookieSecure())) {                                |                                                                                                     
// Fragments use same value - no conflict                                                            |                                                                                                     
} else {                                                                                             |                                                                                                     
log.error(sm.getString("webXml.mergeConflictSessionCookieSecure", fragment.getName(), fragment.getUR |                                                                                                     
return false;                                                                                        |                                                                                                     
}                                                                                                    |                                                                                                     
}                                                                                                    |                                                                                                     
}                                                                                                    |                                                                                                     
if (temp.getSessionConfig().getCookieSecure() != null) {                                             |                                                                                                     
sessionConfig.setCookieSecure(temp.getSessionConfig().getCookieSecure().toString());                 |                                                                                                     
}                                                                                                    |                                                                                                     
}                                                                                                    |                                                                                                     
if (sessionConfig.getCookieMaxAge() == null) {                                                       |                                                                                                     
for (WebXml fragment : fragments) {                                                                  |                                                                                                     
Integer value = fragment.getSessionConfig().getCookieMaxAge();                                       |                                                                                                     
if (value != null) {                                                                                 |                                                                                                     
if (temp.getSessionConfig().getCookieMaxAge() == null) {                                             |                                                                                                     
temp.getSessionConfig().setCookieMaxAge(value.toString());                                           |                                                                                                     
} else if (value.equals(temp.getSessionConfig().getCookieMaxAge())) {                                |                                                                                                     
// Fragments use same value - no conflict                                                            |                                                                                                     
} else {                                                                                             |                                                                                                     
log.error(sm.getString("webXml.mergeConflictSessionCookieMaxAge", fragment.getName(), fragment.getUR |                                                                                                     
return false;                                                                                        |                                                                                                     
}                                                                                                    |                                                                                                     
}                                                                                                    |                                                                                                     
}                                                                                                    |                                                                                                     
if (temp.getSessionConfig().getCookieMaxAge() != null) {                                             |                                                                                                     
sessionConfig.setCookieMaxAge(temp.getSessionConfig().getCookieMaxAge().toString());                 |                                                                                                     
}                                                                                                    |                                                                                                     
}                                                                                                    |                                                                                                     
if (sessionConfig.getSessionTrackingModes().size() == 0) {                                             if (sessionConfig.getSessionTrackingModes().size() == 0) {                                          
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
EnumSet&lt;SessionTrackingMode&gt; value = fragment.getSessionConfig().getSessionTrackingModes();      EnumSet&lt;SessionTrackingMode&gt; value = fragment.getSessionConfig().getSessionTrackingModes();   
if (value.size() &gt; 0) {                                                                             if (value.size() &gt; 0) {                                                                          
if (temp.getSessionConfig().getSessionTrackingModes().size() == 0) {                                   if (temp.getSessionConfig().getSessionTrackingModes().size() == 0) {                                
temp.getSessionConfig().getSessionTrackingModes().addAll(value);                                       temp.getSessionConfig().getSessionTrackingModes().addAll(value);                                    
} else if (value.equals(temp.getSessionConfig().getSessionTrackingModes())) {                          } else if (value.equals(temp.getSessionConfig().getSessionTrackingModes())) {                       
// Fragments use same value - no conflict                                                              // Fragments use same value - no conflict                                                           
} else {                                                                                               } else {                                                                                            
log.error(sm.getString("webXml.mergeConflictSessionTrackingMode", fragment.getName(), fragment.getUR   log.error(sm.getString("webXml.mergeConflictSessionTrackingMode", fragment.getName(), fragment.getUR
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
sessionConfig.getSessionTrackingModes().addAll(temp.getSessionConfig().getSessionTrackingModes());     sessionConfig.getSessionTrackingModes().addAll(temp.getSessionConfig().getSessionTrackingModes());  
}                                                                                                      }                                                                                                   
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (!mergeMap(fragment.getTaglibs(), taglibs, temp.getTaglibs(), fragment, "Taglibs")) {               if (!mergeMap(fragment.getTaglibs(), taglibs, temp.getTaglibs(), fragment, "Taglibs")) {            
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
taglibs.putAll(temp.getTaglibs());                                                                     taglibs.putAll(temp.getTaglibs());                                                                  
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (fragment.alwaysAddWelcomeFiles || welcomeFiles.size() == 0) {                                      if (fragment.alwaysAddWelcomeFiles || welcomeFiles.size() == 0) {                                   
for (String welcomeFile : fragment.getWelcomeFiles()) {                                                for (String welcomeFile : fragment.getWelcomeFiles()) {                                             
addWelcomeFile(welcomeFile);                                                                           addWelcomeFile(welcomeFile);                                                                        
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
if (postConstructMethods.isEmpty()) {                                                                  if (postConstructMethods.isEmpty()) {                                                               
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (!mergeLifecycleCallback(fragment.getPostConstructMethods(), temp.getPostConstructMethods(), frag   if (!mergeLifecycleCallback(fragment.getPostConstructMethods(), temp.getPostConstructMethods(), frag
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
postConstructMethods.putAll(temp.getPostConstructMethods());                                           postConstructMethods.putAll(temp.getPostConstructMethods());                                        
}                                                                                                      }                                                                                                   
if (preDestroyMethods.isEmpty()) {                                                                     if (preDestroyMethods.isEmpty()) {                                                                  
for (WebXml fragment : fragments) {                                                                    for (WebXml fragment : fragments) {                                                                 
if (!mergeLifecycleCallback(fragment.getPreDestroyMethods(), temp.getPreDestroyMethods(), fragment,    if (!mergeLifecycleCallback(fragment.getPreDestroyMethods(), temp.getPreDestroyMethods(), fragment, 
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
preDestroyMethods.putAll(temp.getPreDestroyMethods());                                                 preDestroyMethods.putAll(temp.getPreDestroyMethods());                                              
}                                                                                                      }                                                                                                   
return true;                                                                                           return true;                                                                                        
}                                                                                                      }                                                                                                   
