@Test                                                                                                  @Test                                                                                               
public void testCache() throws Exception {                                                             public void testCache() throws Exception {                                                          
final String THREAD_NAME = "t-TestThreadNameCache";                                                    final String THREAD_NAME = "t-TestThreadNameCache";                                                 
final CountDownLatch threadIdLatch = new CountDownLatch(1);                                            final CountDownLatch threadIdLatch = new CountDownLatch(1);                                         
final CountDownLatch cacheLatch = new CountDownLatch(1);                                               final CountDownLatch cacheLatch = new CountDownLatch(1);                                            
OneLineFormatter olf = new OneLineFormatter();                                                         OneLineFormatter olf = new OneLineFormatter();                                                      
Method getThreadName = olf.getClass().getDeclaredMethod("getThreadName", int.class);                   Method getThreadName = olf.getClass().getDeclaredMethod("getThreadName", int.class);                
getThreadName.setAccessible(true);                                                                     getThreadName.setAccessible(true);                                                                  
Thread thread = new Thread() {                                                                         Thread thread = new Thread() {                                                                      
                                                                                                                                                                                                           
@Override                                                                                              @Override                                                                                           
public void run() {                                                                                    public void run() {                                                                                 
setName(THREAD_NAME);                                                                                  setName(THREAD_NAME);                                                                               
threadId = (int) getId();                                                                            | threadId = Integer.valueOf((int) getId());                                                          
threadIdLatch.countDown();                                                                             threadIdLatch.countDown();                                                                          
try {                                                                                                  try {                                                                                               
cacheLatch.await();                                                                                    cacheLatch.await();                                                                                 
} catch (InterruptedException ex) {                                                                    } catch (InterruptedException ex) {                                                                 
throw new RuntimeException(ex);                                                                        throw new RuntimeException(ex);                                                                     
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
};                                                                                                     };                                                                                                  
thread.start();                                                                                        thread.start();                                                                                     
threadIdLatch.await();                                                                                 threadIdLatch.await();                                                                              
Object name = getThreadName.invoke(olf, threadId);                                                     Object name = getThreadName.invoke(olf, threadId);                                                  
cacheLatch.countDown();                                                                                cacheLatch.countDown();                                                                             
Assert.assertEquals(THREAD_NAME, name);                                                                Assert.assertEquals(THREAD_NAME, name);                                                             
thread.join();                                                                                         thread.join();                                                                                      
name = getThreadName.invoke(olf, threadId);                                                            name = getThreadName.invoke(olf, threadId);                                                         
Assert.assertEquals(THREAD_NAME, name);                                                                Assert.assertEquals(THREAD_NAME, name);                                                             
}                                                                                                      }                                                                                                   
