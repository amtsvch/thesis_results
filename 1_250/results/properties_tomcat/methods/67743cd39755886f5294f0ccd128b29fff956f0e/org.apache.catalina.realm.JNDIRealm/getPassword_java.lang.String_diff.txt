/**                                                                                                    /**                                                                                                 
* Get the password for the specified user.                                                             * Get the password for the specified user.                                                          
* @param username The user name                                                                        * @param username The user name                                                                     
* @return the password associated with the given principal's user name.                                * @return the password associated with the given principal's user name.                             
*/                                                                                                     */                                                                                                  
@Override                                                                                              @Override                                                                                           
protected String getPassword(String username) {                                                        protected String getPassword(String username) {                                                     
String userPassword = getUserPassword();                                                               String userPassword = getUserPassword();                                                            
if (userPassword == null || userPassword.isEmpty()) {                                                  if (userPassword == null || userPassword.isEmpty()) {                                               
return null;                                                                                           return null;                                                                                        
}                                                                                                      }                                                                                                   
JNDIConnection connection = null;                                                                      JNDIConnection connection = null;                                                                   
User user = null;                                                                                      User user = null;                                                                                   
try {                                                                                                  try {                                                                                               
// Ensure that we have a directory context available                                                   // Ensure that we have a directory context available                                                
connection = get();                                                                                    connection = get();                                                                                 
// Occasionally the directory context will timeout.  Try one more                                      // Occasionally the directory context will timeout.  Try one more                                   
// time before giving up.                                                                              // time before giving up.                                                                           
try {                                                                                                  try {                                                                                               
user = getUser(connection, username, null);                                                            user = getUser(connection, username, null);                                                         
} catch (NullPointerException | NamingException e) {                                                   } catch (NullPointerException | NamingException e) {                                                
// log the exception so we know it's there.                                                            // log the exception so we know it's there.                                                         
containerLog.info(sm.getString("jndiRealm.exception.retry"), e);                                       containerLog.info(sm.getString("jndiRealm.exception.retry"), e);                                    
// close the connection so we know it will be reopened.                                                // close the connection so we know it will be reopened.                                             
close(connection);                                                                                     close(connection);                                                                                  
closePooledConnections();                                                                              closePooledConnections();                                                                           
// open a new directory context.                                                                       // open a new directory context.                                                                    
connection = get();                                                                                    connection = get();                                                                                 
// Try the authentication again.                                                                       // Try the authentication again.                                                                    
user = getUser(connection, username, null);                                                            user = getUser(connection, username, null);                                                         
}                                                                                                      }                                                                                                   
// Release this context                                                                                // Release this context                                                                             
release(connection);                                                                                   release(connection);                                                                                
if (user == null) {                                                                                    if (user == null) {                                                                                 
// User should be found...                                                                             // User should be found...                                                                          
return null;                                                                                           return null;                                                                                        
} else {                                                                                               } else {                                                                                            
// ... and have a password                                                                             // ... and have a password                                                                          
return user.getPassword();                                                                             return user.getPassword();                                                                          
}                                                                                                      }                                                                                                   
} catch (NamingException e) {                                                                        | } catch (Exception e) {                                                                             
// Log the problem for posterity                                                                       // Log the problem for posterity                                                                    
containerLog.error(sm.getString("jndiRealm.exception"), e);                                            containerLog.error(sm.getString("jndiRealm.exception"), e);                                         
                                                                                                     | // close the connection so we know it will be reopened.                                             
                                                                                                     | close(connection);                                                                                  
                                                                                                     | closePooledConnections();                                                                           
return null;                                                                                           return null;                                                                                        
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
