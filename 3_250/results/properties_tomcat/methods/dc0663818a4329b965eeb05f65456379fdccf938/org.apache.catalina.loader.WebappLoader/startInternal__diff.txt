/**                                                                                                    /**                                                                                                 
* Start associated {@link ClassLoader} and implement the requirements                                  * Start associated {@link ClassLoader} and implement the requirements                               
* of {@link org.apache.catalina.util.LifecycleBase#startInternal()}.                                   * of {@link org.apache.catalina.util.LifecycleBase#startInternal()}.                                
*                                                                                                      *                                                                                                   
* @exception LifecycleException if this component detects a fatal error                                * @exception LifecycleException if this component detects a fatal error                             
*  that prevents this component from being used                                                        *  that prevents this component from being used                                                     
*/                                                                                                     */                                                                                                  
@Override                                                                                              @Override                                                                                           
protected void startInternal() throws LifecycleException {                                             protected void startInternal() throws LifecycleException {                                          
if (log.isDebugEnabled())                                                                              if (log.isDebugEnabled())                                                                           
log.debug(sm.getString("webappLoader.starting"));                                                      log.debug(sm.getString("webappLoader.starting"));                                                   
if (context.getResources() == null) {                                                                  if (context.getResources() == null) {                                                               
log.info(sm.getString("webappLoader.noResources", context));                                           log.info(sm.getString("webappLoader.noResources", context));                                        
setState(LifecycleState.STARTING);                                                                     setState(LifecycleState.STARTING);                                                                  
return;                                                                                                return;                                                                                             
}                                                                                                      }                                                                                                   
// Construct a class loader based on our current repositories list                                     // Construct a class loader based on our current repositories list                                  
try {                                                                                                  try {                                                                                               
classLoader = createClassLoader();                                                                     classLoader = createClassLoader();                                                                  
classLoader.setResources(context.getResources());                                                      classLoader.setResources(context.getResources());                                                   
classLoader.setDelegate(this.delegate);                                                                classLoader.setDelegate(this.delegate);                                                             
// Set Jakarta class converter                                                                         // Set Jakarta class converter                                                                      
if (getJakartaConverter() != null) {                                                                   if (getJakartaConverter() != null) {                                                                
try {                                                                                                  try {                                                                                               
                                                                                                     | ClassFileTransformer transformer = null;                                                            
                                                                                                     | try {                                                                                               
Class&lt;?&gt; jakartaEnumClass = Class.forName("org.apache.tomcat.jakartaee.EESpecProfile");          Class&lt;?&gt; jakartaEnumClass = Class.forName("org.apache.tomcat.jakartaee.EESpecProfile");       
Method valueOf = jakartaEnumClass.getMethod("valueOf", String.class);                                  Method valueOf = jakartaEnumClass.getMethod("valueOf", String.class);                               
Object profile = null;                                                                               | Object profile = valueOf.invoke(null, getJakartaConverter());                                       
try {                                                                                                | transformer = (ClassFileTransformer) Class.forName("org.apache.tomcat.jakartaee.ClassConverter").get
profile = valueOf.invoke(null, getJakartaConverter());                                               | } catch (InvocationTargetException | NoSuchMethodException ignored) {                               
} catch (InvocationTargetException ignored) {                                                        | // Use default value with no argument constructor                                                   
profile = valueOf.invoke(null, "TOMCAT");                                                            | transformer = (ClassFileTransformer) Class.forName("org.apache.tomcat.jakartaee.ClassConverter").new
}                                                                                                      }                                                                                                   
ClassFileTransformer transformer = (ClassFileTransformer) Class.forName("org.apache.tomcat.jakartaee |                                                                                                     
classLoader.addTransformer(transformer);                                                               classLoader.addTransformer(transformer);                                                            
} catch (InstantiationException | IllegalAccessException | ClassNotFoundException e) {                 } catch (InstantiationException | IllegalAccessException | ClassNotFoundException e) {              
log.warn(sm.getString("webappLoader.noJakartaConverter"), e);                                          log.warn(sm.getString("webappLoader.noJakartaConverter"), e);                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
// Configure our repositories                                                                          // Configure our repositories                                                                       
setClassPath();                                                                                        setClassPath();                                                                                     
setPermissions();                                                                                      setPermissions();                                                                                   
classLoader.start();                                                                                   classLoader.start();                                                                                
String contextName = context.getName();                                                                String contextName = context.getName();                                                             
if (!contextName.startsWith("/")) {                                                                    if (!contextName.startsWith("/")) {                                                                 
contextName = "/" + contextName;                                                                       contextName = "/" + contextName;                                                                    
}                                                                                                      }                                                                                                   
ObjectName cloname = new ObjectName(context.getDomain() + ":type=" + classLoader.getClass().getSimpl   ObjectName cloname = new ObjectName(context.getDomain() + ":type=" + classLoader.getClass().getSimpl
Registry.getRegistry(null, null).registerComponent(classLoader, cloname, null);                        Registry.getRegistry(null, null).registerComponent(classLoader, cloname, null);                     
} catch (Throwable t) {                                                                                } catch (Throwable t) {                                                                             
t = ExceptionUtils.unwrapInvocationTargetException(t);                                                 t = ExceptionUtils.unwrapInvocationTargetException(t);                                              
ExceptionUtils.handleThrowable(t);                                                                     ExceptionUtils.handleThrowable(t);                                                                  
throw new LifecycleException(sm.getString("webappLoader.startError"), t);                              throw new LifecycleException(sm.getString("webappLoader.startError"), t);                           
}                                                                                                      }                                                                                                   
setState(LifecycleState.STARTING);                                                                     setState(LifecycleState.STARTING);                                                                  
}                                                                                                      }                                                                                                   
