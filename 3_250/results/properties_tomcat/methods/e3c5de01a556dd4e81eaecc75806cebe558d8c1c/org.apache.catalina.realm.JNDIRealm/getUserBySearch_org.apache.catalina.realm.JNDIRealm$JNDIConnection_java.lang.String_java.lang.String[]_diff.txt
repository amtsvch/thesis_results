/**                                                                                                    /**                                                                                                 
* Search the directory to return a User object containing                                              * Search the directory to return a User object containing                                           
* information about the user with the specified username, if                                           * information about the user with the specified username, if                                        
* found in the directory; otherwise return &lt;code&gt;null&lt;/code&gt;.                              * found in the directory; otherwise return &lt;code&gt;null&lt;/code&gt;.                           
*                                                                                                      *                                                                                                   
* @param connection The directory context                                                              * @param connection The directory context                                                           
* @param username The username                                                                         * @param username The username                                                                      
* @param attrIds String[]containing names of attributes to retrieve.                                   * @param attrIds String[]containing names of attributes to retrieve.                                
* @return the User object                                                                              * @return the User object                                                                           
* @exception NamingException if a directory server error occurs                                        * @exception NamingException if a directory server error occurs                                     
*/                                                                                                     */                                                                                                  
protected User getUserBySearch(JNDIConnection connection, String username, String[] attrIds) throws    protected User getUserBySearch(JNDIConnection connection, String username, String[] attrIds) throws 
if (username == null || connection.userSearchFormat == null) {                                         if (username == null || connection.userSearchFormat == null) {                                      
return null;                                                                                           return null;                                                                                        
}                                                                                                      }                                                                                                   
// Form the search filter                                                                              // Form the search filter                                                                           
String filter = connection.userSearchFormat.format(new String[] { username });                       | // Escape in case username contains a character with special meaning in                             
                                                                                                     | // a search filter.                                                                                 
                                                                                                     | String filter = connection.userSearchFormat.format(new String[] { doFilterEscaping(username) });    
// Set up the search controls                                                                          // Set up the search controls                                                                       
SearchControls constraints = new SearchControls();                                                     SearchControls constraints = new SearchControls();                                                  
if (userSubtree) {                                                                                     if (userSubtree) {                                                                                  
constraints.setSearchScope(SearchControls.SUBTREE_SCOPE);                                              constraints.setSearchScope(SearchControls.SUBTREE_SCOPE);                                           
} else {                                                                                               } else {                                                                                            
constraints.setSearchScope(SearchControls.ONELEVEL_SCOPE);                                             constraints.setSearchScope(SearchControls.ONELEVEL_SCOPE);                                          
}                                                                                                      }                                                                                                   
constraints.setCountLimit(sizeLimit);                                                                  constraints.setCountLimit(sizeLimit);                                                               
constraints.setTimeLimit(timeLimit);                                                                   constraints.setTimeLimit(timeLimit);                                                                
// Specify the attributes to be retrieved                                                              // Specify the attributes to be retrieved                                                           
if (attrIds == null) {                                                                                 if (attrIds == null) {                                                                              
attrIds = new String[0];                                                                               attrIds = new String[0];                                                                            
}                                                                                                      }                                                                                                   
constraints.setReturningAttributes(attrIds);                                                           constraints.setReturningAttributes(attrIds);                                                        
NamingEnumeration&lt;SearchResult&gt; results = connection.context.search(userBase, filter, constrai   NamingEnumeration&lt;SearchResult&gt; results = connection.context.search(userBase, filter, constrai
try {                                                                                                  try {                                                                                               
// Fail if no entries found                                                                            // Fail if no entries found                                                                         
try {                                                                                                  try {                                                                                               
if (results == null || !results.hasMore()) {                                                           if (results == null || !results.hasMore()) {                                                        
return null;                                                                                           return null;                                                                                        
}                                                                                                      }                                                                                                   
} catch (PartialResultException ex) {                                                                  } catch (PartialResultException ex) {                                                               
if (!adCompat) {                                                                                       if (!adCompat) {                                                                                    
throw ex;                                                                                              throw ex;                                                                                           
} else {                                                                                               } else {                                                                                            
return null;                                                                                           return null;                                                                                        
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
// Get result for the first entry found                                                                // Get result for the first entry found                                                             
SearchResult result = results.next();                                                                  SearchResult result = results.next();                                                               
// Check no further entries were found                                                                 // Check no further entries were found                                                              
try {                                                                                                  try {                                                                                               
if (results.hasMore()) {                                                                               if (results.hasMore()) {                                                                            
if (containerLog.isInfoEnabled()) {                                                                    if (containerLog.isInfoEnabled()) {                                                                 
containerLog.info(sm.getString("jndiRealm.multipleEntries", username));                                containerLog.info(sm.getString("jndiRealm.multipleEntries", username));                             
}                                                                                                      }                                                                                                   
return null;                                                                                           return null;                                                                                        
}                                                                                                      }                                                                                                   
} catch (PartialResultException ex) {                                                                  } catch (PartialResultException ex) {                                                               
if (!adCompat) {                                                                                       if (!adCompat) {                                                                                    
throw ex;                                                                                              throw ex;                                                                                           
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
String dn = getDistinguishedName(connection.context, userBase, result);                                String dn = getDistinguishedName(connection.context, userBase, result);                             
if (containerLog.isTraceEnabled()) {                                                                   if (containerLog.isTraceEnabled()) {                                                                
containerLog.trace("  entry found for " + username + " with dn " + dn);                                containerLog.trace("  entry found for " + username + " with dn " + dn);                             
}                                                                                                      }                                                                                                   
// Get the entry's attributes                                                                          // Get the entry's attributes                                                                       
Attributes attrs = result.getAttributes();                                                             Attributes attrs = result.getAttributes();                                                          
if (attrs == null) {                                                                                   if (attrs == null) {                                                                                
return null;                                                                                           return null;                                                                                        
}                                                                                                      }                                                                                                   
// Retrieve value of userPassword                                                                      // Retrieve value of userPassword                                                                   
String password = null;                                                                                String password = null;                                                                             
if (userPassword != null) {                                                                            if (userPassword != null) {                                                                         
password = getAttributeValue(userPassword, attrs);                                                     password = getAttributeValue(userPassword, attrs);                                                  
}                                                                                                      }                                                                                                   
String userRoleAttrValue = null;                                                                       String userRoleAttrValue = null;                                                                    
if (userRoleAttribute != null) {                                                                       if (userRoleAttribute != null) {                                                                    
userRoleAttrValue = getAttributeValue(userRoleAttribute, attrs);                                       userRoleAttrValue = getAttributeValue(userRoleAttribute, attrs);                                    
}                                                                                                      }                                                                                                   
// Retrieve values of userRoleName attribute                                                           // Retrieve values of userRoleName attribute                                                        
ArrayList&lt;String&gt; roles = null;                                                                  ArrayList&lt;String&gt; roles = null;                                                               
if (userRoleName != null) {                                                                            if (userRoleName != null) {                                                                         
roles = addAttributeValues(userRoleName, attrs, roles);                                                roles = addAttributeValues(userRoleName, attrs, roles);                                             
}                                                                                                      }                                                                                                   
return new User(username, dn, password, roles, userRoleAttrValue);                                     return new User(username, dn, password, roles, userRoleAttrValue);                                  
} finally {                                                                                            } finally {                                                                                         
if (results != null) {                                                                                 if (results != null) {                                                                              
results.close();                                                                                       results.close();                                                                                    
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
