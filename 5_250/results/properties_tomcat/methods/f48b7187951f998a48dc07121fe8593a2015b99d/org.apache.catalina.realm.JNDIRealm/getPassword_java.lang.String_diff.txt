/**                                                                                                    /**                                                                                                 
* Get the password for the specified user.                                                             * Get the password for the specified user.                                                          
* @param username The user name                                                                        * @param username The user name                                                                     
* @return the password associated with the given principal's user name.                                * @return the password associated with the given principal's user name.                             
*/                                                                                                     */                                                                                                  
@Override                                                                                              @Override                                                                                           
protected String getPassword(String username) {                                                        protected String getPassword(String username) {                                                     
String userPassword = getUserPassword();                                                               String userPassword = getUserPassword();                                                            
if (userPassword == null || userPassword.isEmpty()) {                                                  if (userPassword == null || userPassword.isEmpty()) {                                               
return null;                                                                                           return null;                                                                                        
}                                                                                                      }                                                                                                   
                                                                                                     | JNDIConnection connection = null;                                                                   
                                                                                                     | User user = null;                                                                                   
try {                                                                                                  try {                                                                                               
User user = getUser(get(), username, null);                                                          | // Ensure that we have a directory context available                                                
                                                                                                     | connection = get();                                                                                 
                                                                                                     | // Occasionally the directory context will timeout.  Try one more                                   
                                                                                                     | // time before giving up.                                                                           
                                                                                                     | try {                                                                                               
                                                                                                     | user = getUser(connection, username, null);                                                         
                                                                                                     | } catch (NullPointerException | NamingException e) {                                                
                                                                                                     | // log the exception so we know it's there.                                                         
                                                                                                     | containerLog.info(sm.getString("jndiRealm.exception.retry"), e);                                    
                                                                                                     | // close the connection so we know it will be reopened.                                             
                                                                                                     | close(connection);                                                                                  
                                                                                                     | closePooledConnections();                                                                           
                                                                                                     | // open a new directory context.                                                                    
                                                                                                     | connection = get();                                                                                 
                                                                                                     | // Try the authentication again.                                                                    
                                                                                                     | user = getUser(connection, username, null);                                                         
                                                                                                     | }                                                                                                   
                                                                                                     | // Release this context                                                                             
                                                                                                     | release(connection);                                                                                
if (user == null) {                                                                                    if (user == null) {                                                                                 
// User should be found...                                                                             // User should be found...                                                                          
return null;                                                                                           return null;                                                                                        
} else {                                                                                               } else {                                                                                            
// ... and have a password                                                                             // ... and have a password                                                                          
return user.getPassword();                                                                             return user.getPassword();                                                                          
}                                                                                                      }                                                                                                   
} catch (NamingException e) {                                                                          } catch (NamingException e) {                                                                       
                                                                                                     | // Log the problem for posterity                                                                    
                                                                                                     | containerLog.error(sm.getString("jndiRealm.exception"), e);                                         
return null;                                                                                           return null;                                                                                        
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
