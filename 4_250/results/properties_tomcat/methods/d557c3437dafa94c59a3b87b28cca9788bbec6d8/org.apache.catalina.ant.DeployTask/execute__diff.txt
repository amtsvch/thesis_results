/**                                                                                                    /**                                                                                                 
* Execute the requested operation.                                                                     * Execute the requested operation.                                                                  
*                                                                                                      *                                                                                                   
* @exception BuildException if an error occurs                                                         * @exception BuildException if an error occurs                                                      
*/                                                                                                     */                                                                                                  
@Override                                                                                              @Override                                                                                           
public void execute() throws BuildException {                                                          public void execute() throws BuildException {                                                       
super.execute();                                                                                       super.execute();                                                                                    
if (path == null) {                                                                                    if (path == null) {                                                                                 
throw new BuildException("Must specify 'path' attribute");                                             throw new BuildException("Must specify 'path' attribute");                                          
}                                                                                                      }                                                                                                   
if ((war == null) && (localWar == null) && (config == null) && (tag == null)) {                        if ((war == null) && (localWar == null) && (config == null) && (tag == null)) {                     
throw new BuildException("Must specify either 'war', 'localWar', 'config', or 'tag' attribute");       throw new BuildException("Must specify either 'war', 'localWar', 'config', or 'tag' attribute");    
}                                                                                                      }                                                                                                   
// Building an input stream on the WAR to upload, if any                                               // Building an input stream on the WAR to upload, if any                                            
BufferedInputStream stream = null;                                                                     BufferedInputStream stream = null;                                                                  
String contentType = null;                                                                             String contentType = null;                                                                          
long contentLength = -1;                                                                               long contentLength = -1;                                                                            
if (war != null) {                                                                                     if (war != null) {                                                                                  
if (PROTOCOL_PATTERN.matcher(war).lookingAt()) {                                                       if (PROTOCOL_PATTERN.matcher(war).lookingAt()) {                                                    
try {                                                                                                  try {                                                                                               
URL url = new URL(war);                                                                                URL url = new URL(war);                                                                             
URLConnection conn = url.openConnection();                                                             URLConnection conn = url.openConnection();                                                          
contentLength = conn.getContentLengthLong();                                                           contentLength = conn.getContentLengthLong();                                                        
stream = new BufferedInputStream(conn.getInputStream(), 1024);                                         stream = new BufferedInputStream(conn.getInputStream(), 1024);                                      
} catch (IOException e) {                                                                              } catch (IOException e) {                                                                           
throw new BuildException(e);                                                                           throw new BuildException(e);                                                                        
}                                                                                                      }                                                                                                   
} else {                                                                                               } else {                                                                                            
try (FileInputStream fsInput = new FileInputStream(war);                                             | FileInputStream fsInput = null;                                                                     
FileChannel fsChannel = fsInput.getChannel()) {                                                      | try {                                                                                               
                                                                                                     | fsInput = new FileInputStream(war);                                                                 
                                                                                                     | FileChannel fsChannel = fsInput.getChannel();                                                       
contentLength = fsChannel.size();                                                                      contentLength = fsChannel.size();                                                                   
stream = new BufferedInputStream(fsInput, 1024);                                                       stream = new BufferedInputStream(fsInput, 1024);                                                    
} catch (IOException e) {                                                                              } catch (IOException e) {                                                                           
                                                                                                     | if (fsInput != null) {                                                                              
                                                                                                     | try {                                                                                               
                                                                                                     | fsInput.close();                                                                                    
                                                                                                     | } catch (IOException ioe) {                                                                         
                                                                                                     | // Ignore                                                                                           
                                                                                                     | }                                                                                                   
                                                                                                     | }                                                                                                   
throw new BuildException(e);                                                                           throw new BuildException(e);                                                                        
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
contentType = "application/octet-stream";                                                              contentType = "application/octet-stream";                                                           
}                                                                                                      }                                                                                                   
// Building URL                                                                                        // Building URL                                                                                     
StringBuilder sb = createQueryString("/deploy");                                                       StringBuilder sb = createQueryString("/deploy");                                                    
try {                                                                                                  try {                                                                                               
if ((war == null) && (config != null)) {                                                               if ((war == null) && (config != null)) {                                                            
sb.append("&config=");                                                                                 sb.append("&config=");                                                                              
sb.append(URLEncoder.encode(config, getCharset()));                                                    sb.append(URLEncoder.encode(config, getCharset()));                                                 
}                                                                                                      }                                                                                                   
if ((war == null) && (localWar != null)) {                                                             if ((war == null) && (localWar != null)) {                                                          
sb.append("&war=");                                                                                    sb.append("&war=");                                                                                 
sb.append(URLEncoder.encode(localWar, getCharset()));                                                  sb.append(URLEncoder.encode(localWar, getCharset()));                                               
}                                                                                                      }                                                                                                   
if (update) {                                                                                          if (update) {                                                                                       
sb.append("&update=true");                                                                             sb.append("&update=true");                                                                          
}                                                                                                      }                                                                                                   
if (tag != null) {                                                                                     if (tag != null) {                                                                                  
sb.append("&tag=");                                                                                    sb.append("&tag=");                                                                                 
sb.append(URLEncoder.encode(tag, getCharset()));                                                       sb.append(URLEncoder.encode(tag, getCharset()));                                                    
}                                                                                                      }                                                                                                   
execute(sb.toString(), stream, contentType, contentLength);                                            execute(sb.toString(), stream, contentType, contentLength);                                         
} catch (UnsupportedEncodingException e) {                                                             } catch (UnsupportedEncodingException e) {                                                          
throw new BuildException("Invalid 'charset' attribute: " + getCharset());                              throw new BuildException("Invalid 'charset' attribute: " + getCharset());                           
} finally {                                                                                            } finally {                                                                                         
if (stream != null) {                                                                                  if (stream != null) {                                                                               
try {                                                                                                  try {                                                                                               
stream.close();                                                                                        stream.close();                                                                                     
} catch (IOException ioe) {                                                                            } catch (IOException ioe) {                                                                         
// Ignore                                                                                              // Ignore                                                                                           
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
