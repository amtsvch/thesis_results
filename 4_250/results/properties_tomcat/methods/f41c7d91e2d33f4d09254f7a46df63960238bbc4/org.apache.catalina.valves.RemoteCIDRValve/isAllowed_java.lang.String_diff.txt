@Override                                                                                              @Override                                                                                           
public boolean isAllowed(final String property) {                                                      public boolean isAllowed(final String property) {                                                   
final int portIdx = property.indexOf(";");                                                           | final int portIdx = property.indexOf(';');                                                          
final int port;                                                                                        final int port;                                                                                     
final String nonPortPart;                                                                              final String nonPortPart;                                                                           
if (portIdx == -1) {                                                                                   if (portIdx == -1) {                                                                                
if (getAddConnectorPort()) {                                                                           if (getAddConnectorPort()) {                                                                        
log.error(sm.getString("remoteCidrValve.noPort"));                                                     log.error(sm.getString("remoteCidrValve.noPort"));                                                  
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
port = -1;                                                                                             port = -1;                                                                                          
nonPortPart = property;                                                                                nonPortPart = property;                                                                             
} else {                                                                                               } else {                                                                                            
if (!getAddConnectorPort()) {                                                                          if (!getAddConnectorPort()) {                                                                       
log.error(sm.getString("remoteCidrValve.unexpectedPort"));                                             log.error(sm.getString("remoteCidrValve.unexpectedPort"));                                          
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
nonPortPart = property.substring(0, portIdx);                                                          nonPortPart = property.substring(0, portIdx);                                                       
try {                                                                                                  try {                                                                                               
port = Integer.parseInt(property.substring(portIdx + 1));                                              port = Integer.parseInt(property.substring(portIdx + 1));                                           
} catch (NumberFormatException e) {                                                                    } catch (NumberFormatException e) {                                                                 
// This should be in the 'could never happen' category but handle it                                   // This should be in the 'could never happen' category but handle it                                
// to be safe.                                                                                         // to be safe.                                                                                      
log.error(sm.getString("remoteCidrValve.noPort"), e);                                                  log.error(sm.getString("remoteCidrValve.noPort"), e);                                               
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
final InetAddress addr;                                                                                final InetAddress addr;                                                                             
try {                                                                                                  try {                                                                                               
addr = InetAddress.getByName(nonPortPart);                                                             addr = InetAddress.getByName(nonPortPart);                                                          
} catch (UnknownHostException e) {                                                                     } catch (UnknownHostException e) {                                                                  
// This should be in the 'could never happen' category but handle it                                   // This should be in the 'could never happen' category but handle it                                
// to be safe.                                                                                         // to be safe.                                                                                      
log.error(sm.getString("remoteCidrValve.noRemoteIp"), e);                                              log.error(sm.getString("remoteCidrValve.noRemoteIp"), e);                                           
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
for (final NetMask nm : deny) {                                                                        for (final NetMask nm : deny) {                                                                     
if (getAddConnectorPort()) {                                                                           if (getAddConnectorPort()) {                                                                        
if (nm.matches(addr, port)) {                                                                          if (nm.matches(addr, port)) {                                                                       
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
} else {                                                                                               } else {                                                                                            
if (nm.matches(addr)) {                                                                                if (nm.matches(addr)) {                                                                             
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
for (final NetMask nm : allow) {                                                                       for (final NetMask nm : allow) {                                                                    
if (getAddConnectorPort()) {                                                                           if (getAddConnectorPort()) {                                                                        
if (nm.matches(addr, port)) {                                                                          if (nm.matches(addr, port)) {                                                                       
return true;                                                                                           return true;                                                                                        
}                                                                                                      }                                                                                                   
} else {                                                                                               } else {                                                                                            
if (nm.matches(addr)) {                                                                                if (nm.matches(addr)) {                                                                             
return true;                                                                                           return true;                                                                                        
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
// Allow if deny is specified but allow isn't                                                          // Allow if deny is specified but allow isn't                                                       
if (!deny.isEmpty() && allow.isEmpty()) {                                                              if (!deny.isEmpty() && allow.isEmpty()) {                                                           
return true;                                                                                           return true;                                                                                        
}                                                                                                      }                                                                                                   
// Deny this request                                                                                   // Deny this request                                                                                
return false;                                                                                          return false;                                                                                       
}                                                                                                      }                                                                                                   
