@Override                                                                                              @Override                                                                                           
public Resource getResource(String name) throws IOException {                                          public Resource getResource(String name) throws IOException {                                       
// Location was originally always a file before URI support was added so                               // Location was originally always a file before URI support was added so                            
// try file first.                                                                                     // try file first.                                                                                  
File f = new File(name);                                                                               File f = new File(name);                                                                            
if (!f.isAbsolute()) {                                                                                 if (!f.isAbsolute()) {                                                                              
f = new File(catalinaBaseFile, name);                                                                  f = new File(catalinaBaseFile, name);                                                               
}                                                                                                      }                                                                                                   
if (f.isFile()) {                                                                                      if (f.isFile()) {                                                                                   
FileInputStream fis = new FileInputStream(f);                                                          FileInputStream fis = new FileInputStream(f);                                                       
return new Resource(fis, f.toURI());                                                                   return new Resource(fis, f.toURI());                                                                
}                                                                                                      }                                                                                                   
// Try classloader                                                                                     // Try classloader                                                                                  
InputStream stream = null;                                                                             InputStream stream = null;                                                                          
try {                                                                                                  try {                                                                                               
stream = getClass().getClassLoader().getResourceAsStream(name);                                        stream = getClass().getClassLoader().getResourceAsStream(name);                                     
if (stream != null) {                                                                                  if (stream != null) {                                                                               
return new Resource(stream, getClass().getClassLoader().getResource(name).toURI());                    return new Resource(stream, getClass().getClassLoader().getResource(name).toURI());                 
}                                                                                                      }                                                                                                   
} catch (InvalidPathException e) {                                                                     } catch (InvalidPathException e) {                                                                  
// Ignore. Some valid file URIs can trigger this.                                                      // Ignore. Some valid file URIs can trigger this.                                                   
// Stream should be null here but check to be on the safe side.                                        // Stream should be null here but check to be on the safe side.                                     
if (stream != null) {                                                                                  if (stream != null) {                                                                               
stream.close();                                                                                        stream.close();                                                                                     
}                                                                                                      }                                                                                                   
} catch (URISyntaxException e) {                                                                       } catch (URISyntaxException e) {                                                                    
stream.close();                                                                                        stream.close();                                                                                     
throw new IOException(sm.getString("catalinaConfigurationSource.cannotObtainURL", name), e);           throw new IOException(sm.getString("catalinaConfigurationSource.cannotObtainURL", name), e);        
}                                                                                                      }                                                                                                   
// Then try URI.                                                                                       // Then try URI.                                                                                    
URI uri = null;                                                                                        URI uri = null;                                                                                     
try {                                                                                                  try {                                                                                               
uri = getURI(name);                                                                                  | uri = getURIInternal(name);                                                                         
} catch (IllegalArgumentException e) {                                                                 } catch (IllegalArgumentException e) {                                                              
throw new IOException(sm.getString("catalinaConfigurationSource.cannotObtainURL", name), e);           throw new IOException(sm.getString("catalinaConfigurationSource.cannotObtainURL", name), e);        
}                                                                                                      }                                                                                                   
// Obtain the input stream we need                                                                     // Obtain the input stream we need                                                                  
try {                                                                                                  try {                                                                                               
URL url = uri.toURL();                                                                                 URL url = uri.toURL();                                                                              
return new Resource(url.openConnection().getInputStream(), uri);                                       return new Resource(url.openConnection().getInputStream(), uri);                                    
} catch (MalformedURLException e) {                                                                    } catch (MalformedURLException e) {                                                                 
throw new IOException(sm.getString("catalinaConfigurationSource.cannotObtainURL", name), e);           throw new IOException(sm.getString("catalinaConfigurationSource.cannotObtainURL", name), e);        
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
