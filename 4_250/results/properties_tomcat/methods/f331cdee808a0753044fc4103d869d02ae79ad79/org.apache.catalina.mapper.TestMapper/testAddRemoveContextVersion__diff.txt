@Test
public void testAddRemoveContextVersion() throws Exception {
    final String hostName = "iowejoiejfoiew";
    final int iowPos = 4;
    final String contextPath = "/foo/bar";
    final int contextPos = 2;
    MappingData mappingData = new MappingData();
    MessageBytes hostMB = MessageBytes.newInstance();
    MessageBytes uriMB = MessageBytes.newInstance();
    hostMB.setString(hostName);
    uriMB.setString("/foo/bar/blah/bobou/foo");
    // Verifying configuration created by setUp()
    Mapper.MappedHost mappedHost = mapper.hosts[iowPos];
    Assert.assertEquals(hostName, mappedHost.name);
    Mapper.MappedContext mappedContext = mappedHost.contextList.contexts[contextPos];
    Assert.assertEquals(contextPath, mappedContext.name);
    Assert.assertEquals(1, mappedContext.versions.length);
    Assert.assertEquals("0", mappedContext.versions[0].name);
    Host oldHost = mappedHost.object;
    Context oldContext = mappedContext.versions[0].object;
    Assert.assertEquals("context2", oldContext.getName());
    Context oldContext1 = mappedHost.contextList.contexts[contextPos - 1].versions[0].object;
    Assert.assertEquals("context1", oldContext1.getName());
    mappingData.recycle();
    mapper.map(hostMB, uriMB, null, mappingData);
    Assert.assertEquals("blah7", mappingData.host.getName());
    Assert.assertEquals("context2", mappingData.context.getName());
    Assert.assertEquals("wrapper5", mappingData.wrapper.getName());
    mappingData.recycle();
    mapper.map(oldContext, uriMB, mappingData);
    Assert.assertEquals("wrapper5", mappingData.wrapper.getName());
    Context newContext = createContext("newContext");
    mapper.addContextVersion(hostName, oldHost, contextPath, "1", newContext, null, null, Arrays.asList(new WrapperMappingInfo[] { new WrapperMappingInfo("/", createWrapper("newContext-default"), false, false) }));
    Assert.assertEquals(2, mappedContext.versions.length);
    Assert.assertEquals("0", mappedContext.versions[0].name);
    Assert.assertEquals("1", mappedContext.versions[1].name);
    mappingData.recycle();
    mapper.map(hostMB, uriMB, null, mappingData);
    Assert.assertEquals("newContext", mappingData.context.getName());
    Assert.assertEquals("newContext-default", mappingData.wrapper.getName());
    mappingData.recycle();
    mapper.map(newContext, uriMB, mappingData);
    Assert.assertEquals("newContext-default", mappingData.wrapper.getName());
    mapper.removeContextVersion(oldContext, hostName, contextPath, "0");
    Assert.assertEquals(1, mappedContext.versions.length);
    Assert.assertEquals("1", mappedContext.versions[0].name);
    mappingData.recycle();
    mapper.map(hostMB, uriMB, null, mappingData);
    Assert.assertEquals("newContext", mappingData.context.getName());
    Assert.assertEquals("newContext-default", mappingData.wrapper.getName());
    mappingData.recycle();
    mapper.map(newContext, uriMB, mappingData);
    Assert.assertEquals("newContext-default", mappingData.wrapper.getName());
    mapper.removeContextVersion(oldContext, hostName, contextPath, "1");
    Assert.assertNotSame(mappedContext, mappedHost.contextList.contexts[contextPos]);
    Assert.assertEquals("/foo/bar/bla", mappedHost.contextList.contexts[contextPos].name);
    mappingData.recycle();
    mapper.map(hostMB, uriMB, null, mappingData);
    Assert.assertEquals("context1", mappingData.context.getName());
    Assert.assertEquals("context1-defaultWrapper", mappingData.wrapper.getName());
    mappingData.recycle();
    mapper.map(oldContext1, uriMB, mappingData);
    Assert.assertEquals("context1-defaultWrapper", mappingData.wrapper.getName());
    mapper.addContextVersion(hostName, oldHost, contextPath, "0", newContext, null, null, Arrays.asList(new WrapperMappingInfo[] { new WrapperMappingInfo("/", createWrapper("newContext-defaultWrapper2"), false, false) }));
    mappedContext = mappedHost.contextList.contexts[contextPos];
    Assert.assertEquals(contextPath, mappedContext.name);
    Assert.assertEquals(1, mappedContext.versions.length);
    Assert.assertEquals("0", mappedContext.versions[0].name);
    mappingData.recycle();
    mapper.map(hostMB, uriMB, null, mappingData);
    Assert.assertEquals("newContext", mappingData.context.getName());
    Assert.assertEquals("newContext-defaultWrapper2", mappingData.wrapper.getName());
    mappingData.recycle();
    mapper.map(newContext, uriMB, mappingData);
    Assert.assertEquals("newContext-defaultWrapper2", mappingData.wrapper.getName());
}