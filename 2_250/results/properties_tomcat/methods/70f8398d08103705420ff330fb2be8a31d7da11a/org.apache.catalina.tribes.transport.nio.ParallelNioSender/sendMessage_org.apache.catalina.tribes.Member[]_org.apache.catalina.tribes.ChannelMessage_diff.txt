@Override                                                                                              @Override                                                                                           
public synchronized void sendMessage(Member[] destination, ChannelMessage msg) throws ChannelExcepti   public synchronized void sendMessage(Member[] destination, ChannelMessage msg) throws ChannelExcepti
long start = System.currentTimeMillis();                                                               long start = System.currentTimeMillis();                                                            
this.setUdpBased((msg.getOptions() & Channel.SEND_OPTIONS_UDP) == Channel.SEND_OPTIONS_UDP);           this.setUdpBased((msg.getOptions() & Channel.SEND_OPTIONS_UDP) == Channel.SEND_OPTIONS_UDP);        
byte[] data = XByteBuffer.createDataPackage((ChannelData) msg);                                        byte[] data = XByteBuffer.createDataPackage((ChannelData) msg);                                     
NioSender[] senders = setupForSend(destination);                                                       NioSender[] senders = setupForSend(destination);                                                    
connect(senders);                                                                                      connect(senders);                                                                                   
setData(senders, data);                                                                                setData(senders, data);                                                                             
int remaining = senders.length;                                                                        int remaining = senders.length;                                                                     
ChannelException cx = null;                                                                            ChannelException cx = null;                                                                         
try {                                                                                                  try {                                                                                               
// loop until complete, an error happens, or we timeout                                                // loop until complete, an error happens, or we timeout                                             
long delta = System.currentTimeMillis() - start;                                                       long delta = System.currentTimeMillis() - start;                                                    
boolean waitForAck = (Channel.SEND_OPTIONS_USE_ACK & msg.getOptions()) == Channel.SEND_OPTIONS_USE_A   boolean waitForAck = (Channel.SEND_OPTIONS_USE_ACK & msg.getOptions()) == Channel.SEND_OPTIONS_USE_A
while ((remaining &gt; 0) && (delta &lt; getTimeout())) {                                              while ((remaining &gt; 0) && (delta &lt; getTimeout())) {                                           
try {                                                                                                  try {                                                                                               
SendResult result = doLoop(selectTimeout, getMaxRetryAttempts(), waitForAck, msg);                     SendResult result = doLoop(selectTimeout, getMaxRetryAttempts(), waitForAck, msg);                  
remaining -= result.getCompleted();                                                                    remaining -= result.getCompleted();                                                                 
if (result.getFailed() != null) {                                                                      if (result.getFailed() != null) {                                                                   
remaining -= result.getFailed().getFaultyMembers().length;                                             remaining -= result.getFailed().getFaultyMembers().length;                                          
if (cx == null)                                                                                      | if (cx == null) {                                                                                   
cx = result.getFailed();                                                                               cx = result.getFailed();                                                                            
else                                                                                                 | } else {                                                                                            
cx.addFaultyMember(result.getFailed().getFaultyMembers());                                             cx.addFaultyMember(result.getFailed().getFaultyMembers());                                          
}                                                                                                      }                                                                                                   
                                                                                                     | }                                                                                                   
} catch (Exception x) {                                                                                } catch (Exception x) {                                                                             
if (log.isTraceEnabled())                                                                            | if (log.isTraceEnabled()) {                                                                         
log.trace("Error sending message", x);                                                                 log.trace("Error sending message", x);                                                              
                                                                                                     | }                                                                                                   
if (cx == null) {                                                                                      if (cx == null) {                                                                                   
if (x instanceof ChannelException)                                                                   | if (x instanceof ChannelException) {                                                                
cx = (ChannelException) x;                                                                             cx = (ChannelException) x;                                                                          
else                                                                                                 | } else {                                                                                            
cx = new ChannelException(sm.getString("parallelNioSender.send.failed"), x);                           cx = new ChannelException(sm.getString("parallelNioSender.send.failed"), x);                        
}                                                                                                      }                                                                                                   
                                                                                                     | }                                                                                                   
for (NioSender sender : senders) {                                                                     for (NioSender sender : senders) {                                                                  
if (!sender.isComplete()) {                                                                            if (!sender.isComplete()) {                                                                         
cx.addFaultyMember(sender.getDestination(), x);                                                        cx.addFaultyMember(sender.getDestination(), x);                                                     
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
throw cx;                                                                                              throw cx;                                                                                           
}                                                                                                      }                                                                                                   
delta = System.currentTimeMillis() - start;                                                            delta = System.currentTimeMillis() - start;                                                         
}                                                                                                      }                                                                                                   
if (remaining &gt; 0) {                                                                                if (remaining &gt; 0) {                                                                             
// timeout has occurred                                                                                // timeout has occurred                                                                             
ChannelException cxtimeout = new ChannelException(sm.getString("parallelNioSender.operation.timedout   ChannelException cxtimeout = new ChannelException(sm.getString("parallelNioSender.operation.timedout
if (cx == null) {                                                                                      if (cx == null) {                                                                                   
cx = new ChannelException(sm.getString("parallelNioSender.operation.timedout", Long.toString(getTime   cx = new ChannelException(sm.getString("parallelNioSender.operation.timedout", Long.toString(getTime
}                                                                                                      }                                                                                                   
for (NioSender sender : senders) {                                                                     for (NioSender sender : senders) {                                                                  
if (!sender.isComplete()) {                                                                            if (!sender.isComplete()) {                                                                         
cx.addFaultyMember(sender.getDestination(), cxtimeout);                                                cx.addFaultyMember(sender.getDestination(), cxtimeout);                                             
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
throw cx;                                                                                              throw cx;                                                                                           
} else if (cx != null) {                                                                               } else if (cx != null) {                                                                            
// there was an error                                                                                  // there was an error                                                                               
throw cx;                                                                                              throw cx;                                                                                           
}                                                                                                      }                                                                                                   
} catch (Exception x) {                                                                                } catch (Exception x) {                                                                             
try {                                                                                                  try {                                                                                               
this.disconnect();                                                                                     this.disconnect();                                                                                  
} catch (Exception e) {                                                                                } catch (Exception e) {                                                                             
// Ignore                                                                                              // Ignore                                                                                           
}                                                                                                      }                                                                                                   
if (x instanceof ChannelException)                                                                   | if (x instanceof ChannelException) {                                                                
throw (ChannelException) x;                                                                            throw (ChannelException) x;                                                                         
else                                                                                                 | } else {                                                                                            
throw new ChannelException(x);                                                                         throw new ChannelException(x);                                                                      
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
                                                                                                     | }                                                                                                   
