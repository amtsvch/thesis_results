/**                                                                                                    /**                                                                                                 
* Start the service                                                                                    * Start the service                                                                                 
* @param level 1 starts the receiver, level 2 starts the sender                                        * @param level 1 starts the receiver, level 2 starts the sender                                     
* @throws IOException if the service fails to start                                                    * @throws IOException if the service fails to start                                                 
* @throws IllegalStateException if the service is already started                                      * @throws IllegalStateException if the service is already started                                   
*/                                                                                                     */                                                                                                  
@Override                                                                                              @Override                                                                                           
public synchronized void start(int level) throws IOException {                                         public synchronized void start(int level) throws IOException {                                      
boolean valid = false;                                                                                 boolean valid = false;                                                                              
if ((level & Channel.MBR_RX_SEQ) == Channel.MBR_RX_SEQ) {                                              if ((level & Channel.MBR_RX_SEQ) == Channel.MBR_RX_SEQ) {                                           
if (receiver != null)                                                                                | if (receiver != null) {                                                                             
throw new IllegalStateException(sm.getString("mcastServiceImpl.receive.running"));                     throw new IllegalStateException(sm.getString("mcastServiceImpl.receive.running"));                  
                                                                                                     | }                                                                                                   
try {                                                                                                  try {                                                                                               
if (sender == null)                                                                                  | if (sender == null) {                                                                               
socket.joinGroup(address);                                                                             socket.joinGroup(address);                                                                          
                                                                                                     | }                                                                                                   
} catch (IOException iox) {                                                                            } catch (IOException iox) {                                                                         
log.error(sm.getString("mcastServiceImpl.unable.join"));                                               log.error(sm.getString("mcastServiceImpl.unable.join"));                                            
throw iox;                                                                                             throw iox;                                                                                          
}                                                                                                      }                                                                                                   
doRunReceiver = true;                                                                                  doRunReceiver = true;                                                                               
receiver = new ReceiverThread();                                                                       receiver = new ReceiverThread();                                                                    
receiver.setDaemon(true);                                                                              receiver.setDaemon(true);                                                                           
receiver.start();                                                                                      receiver.start();                                                                                   
valid = true;                                                                                          valid = true;                                                                                       
}                                                                                                      }                                                                                                   
if ((level & Channel.MBR_TX_SEQ) == Channel.MBR_TX_SEQ) {                                              if ((level & Channel.MBR_TX_SEQ) == Channel.MBR_TX_SEQ) {                                           
if (sender != null)                                                                                  | if (sender != null) {                                                                               
throw new IllegalStateException(sm.getString("mcastServiceImpl.send.running"));                        throw new IllegalStateException(sm.getString("mcastServiceImpl.send.running"));                     
if (receiver == null)                                                                                | }                                                                                                   
                                                                                                     | if (receiver == null) {                                                                             
socket.joinGroup(address);                                                                             socket.joinGroup(address);                                                                          
                                                                                                     | }                                                                                                   
// make sure at least one packet gets out there                                                        // make sure at least one packet gets out there                                                     
send(false);                                                                                           send(false);                                                                                        
doRunSender = true;                                                                                    doRunSender = true;                                                                                 
sender = new SenderThread(sendFrequency);                                                              sender = new SenderThread(sendFrequency);                                                           
sender.setDaemon(true);                                                                                sender.setDaemon(true);                                                                             
sender.start();                                                                                        sender.start();                                                                                     
// we have started the receiver, but not yet waited for membership to establish                        // we have started the receiver, but not yet waited for membership to establish                     
valid = true;                                                                                          valid = true;                                                                                       
}                                                                                                      }                                                                                                   
if (!valid) {                                                                                          if (!valid) {                                                                                       
throw new IllegalArgumentException(sm.getString("mcastServiceImpl.invalid.startLevel"));               throw new IllegalArgumentException(sm.getString("mcastServiceImpl.invalid.startLevel"));            
}                                                                                                      }                                                                                                   
// pause, once or twice                                                                                // pause, once or twice                                                                             
waitForMembers(level);                                                                                 waitForMembers(level);                                                                              
startLevel = (startLevel | level);                                                                     startLevel = (startLevel | level);                                                                  
}                                                                                                      }                                                                                                   
