public void setMessage(byte[] data, int offset, int length) throws IOException {                       public void setMessage(byte[] data, int offset, int length) throws IOException {                    
if (data != null) {                                                                                    if (data != null) {                                                                                 
synchronized (this) {                                                                                  synchronized (this) {                                                                               
current = data;                                                                                        current = data;                                                                                     
remaining = length;                                                                                    remaining = length;                                                                                 
ackbuf.clear();                                                                                        ackbuf.clear();                                                                                     
if (writebuf != null) {                                                                                if (writebuf != null) {                                                                             
writebuf.clear();                                                                                      writebuf.clear();                                                                                   
} else {                                                                                               } else {                                                                                            
writebuf = getBuffer(length);                                                                          writebuf = getBuffer(length);                                                                       
}                                                                                                      }                                                                                                   
if (writebuf.capacity() &lt; length) {                                                                 if (writebuf.capacity() &lt; length) {                                                              
writebuf = getBuffer(length);                                                                          writebuf = getBuffer(length);                                                                       
}                                                                                                      }                                                                                                   
// TODO use ByteBuffer.wrap to avoid copying the data.                                                 // TODO use ByteBuffer.wrap to avoid copying the data.                                              
writebuf.put(data, offset, length);                                                                    writebuf.put(data, offset, length);                                                                 
writebuf.flip();                                                                                       writebuf.flip();                                                                                    
if (isConnected()) {                                                                                   if (isConnected()) {                                                                                
if (isUdpBased())                                                                                    | if (isUdpBased()) {                                                                                 
dataChannel.register(getSelector(), SelectionKey.OP_WRITE, this);                                      dataChannel.register(getSelector(), SelectionKey.OP_WRITE, this);                                   
else                                                                                                 | } else {                                                                                            
socketChannel.register(getSelector(), SelectionKey.OP_WRITE, this);                                    socketChannel.register(getSelector(), SelectionKey.OP_WRITE, this);                                 
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
                                                                                                     | }                                                                                                   
