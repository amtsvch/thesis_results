private void closeSelector() throws IOException {                                                      private void closeSelector() throws IOException {                                                   
Selector selector = this.selector.getAndSet(null);                                                     Selector selector = this.selector.getAndSet(null);                                                  
if (selector == null)                                                                                | if (selector == null) {                                                                             
return;                                                                                                return;                                                                                             
                                                                                                     | }                                                                                                   
try {                                                                                                  try {                                                                                               
// look at each key in the selected set                                                                // look at each key in the selected set                                                             
for (SelectionKey key : selector.keys()) {                                                             for (SelectionKey key : selector.keys()) {                                                          
key.channel().close();                                                                                 key.channel().close();                                                                              
key.attach(null);                                                                                      key.attach(null);                                                                                   
key.cancel();                                                                                          key.cancel();                                                                                       
}                                                                                                      }                                                                                                   
} catch (IOException ignore) {                                                                         } catch (IOException ignore) {                                                                      
if (log.isWarnEnabled()) {                                                                             if (log.isWarnEnabled()) {                                                                          
log.warn(sm.getString("nioReceiver.cleanup.fail"), ignore);                                            log.warn(sm.getString("nioReceiver.cleanup.fail"), ignore);                                         
}                                                                                                      }                                                                                                   
} catch (ClosedSelectorException ignore) {                                                             } catch (ClosedSelectorException ignore) {                                                          
// Ignore                                                                                              // Ignore                                                                                           
}                                                                                                      }                                                                                                   
try {                                                                                                  try {                                                                                               
selector.selectNow();                                                                                  selector.selectNow();                                                                               
} catch (Throwable t) {                                                                                } catch (Throwable t) {                                                                             
ExceptionUtils.handleThrowable(t);                                                                     ExceptionUtils.handleThrowable(t);                                                                  
// Ignore everything else                                                                              // Ignore everything else                                                                           
}                                                                                                      }                                                                                                   
selector.close();                                                                                      selector.close();                                                                                   
}                                                                                                      }                                                                                                   
