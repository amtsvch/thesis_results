/**                                                                                                    /**                                                                                                 
* Create and return a &lt;code&gt;ModelMBean&lt;/code&gt; that has been                                * Create and return a &lt;code&gt;ModelMBean&lt;/code&gt; that has been                             
* preconfigured with the &lt;code&gt;ModelMBeanInfo&lt;/code&gt; information                           * preconfigured with the &lt;code&gt;ModelMBeanInfo&lt;/code&gt; information                        
* for this managed bean, and is associated with the specified                                          * for this managed bean, and is associated with the specified                                       
* managed object instance.  The returned &lt;code&gt;ModelMBean&lt;/code&gt;                           * managed object instance.  The returned &lt;code&gt;ModelMBean&lt;/code&gt;                        
* will &lt;strong&gt;NOT&lt;/strong&gt; have been registered with our                                  * will &lt;strong&gt;NOT&lt;/strong&gt; have been registered with our                               
* &lt;code&gt;MBeanServer&lt;/code&gt;.                                                                * &lt;code&gt;MBeanServer&lt;/code&gt;.                                                             
*                                                                                                      *                                                                                                   
* @param instance Instanced of the managed object, or &lt;code&gt;null&lt;/code&gt;                    * @param instance Instanced of the managed object, or &lt;code&gt;null&lt;/code&gt;                 
*  for no associated instance                                                                          *  for no associated instance                                                                       
* @return the MBean                                                                                    * @return the MBean                                                                                 
* @exception InstanceNotFoundException if the managed resource                                         * @exception InstanceNotFoundException if the managed resource                                      
*  object cannot be found                                                                              *  object cannot be found                                                                           
* @exception MBeanException if a problem occurs instantiating the                                      * @exception MBeanException if a problem occurs instantiating the                                   
*  &lt;code&gt;ModelMBean&lt;/code&gt; instance                                                        *  &lt;code&gt;ModelMBean&lt;/code&gt; instance                                                     
* @exception RuntimeOperationsException if a JMX runtime error occurs                                  * @exception RuntimeOperationsException if a JMX runtime error occurs                               
*/                                                                                                     */                                                                                                  
public DynamicMBean createMBean(Object instance) throws InstanceNotFoundException, MBeanException, R   public DynamicMBean createMBean(Object instance) throws InstanceNotFoundException, MBeanException, R
BaseModelMBean mbean = null;                                                                           BaseModelMBean mbean = null;                                                                        
// Load the ModelMBean implementation class                                                            // Load the ModelMBean implementation class                                                         
if (getClassName().equals(BASE_MBEAN)) {                                                               if (getClassName().equals(BASE_MBEAN)) {                                                            
// Skip introspection                                                                                  // Skip introspection                                                                               
mbean = new BaseModelMBean();                                                                          mbean = new BaseModelMBean();                                                                       
} else {                                                                                               } else {                                                                                            
Class&lt;?&gt; clazz = null;                                                                           Class&lt;?&gt; clazz = null;                                                                        
Exception ex = null;                                                                                   Exception ex = null;                                                                                
try {                                                                                                  try {                                                                                               
clazz = Class.forName(getClassName());                                                                 clazz = Class.forName(getClassName());                                                              
} catch (Exception e) {                                                                                } catch (Exception e) {                                                                             
}                                                                                                      }                                                                                                   
if (clazz == null) {                                                                                   if (clazz == null) {                                                                                
try {                                                                                                  try {                                                                                               
ClassLoader cl = Thread.currentThread().getContextClassLoader();                                       ClassLoader cl = Thread.currentThread().getContextClassLoader();                                    
if (cl != null)                                                                                      | if (cl != null) {                                                                                   
clazz = cl.loadClass(getClassName());                                                                  clazz = cl.loadClass(getClassName());                                                               
                                                                                                     | }                                                                                                   
} catch (Exception e) {                                                                                } catch (Exception e) {                                                                             
ex = e;                                                                                                ex = e;                                                                                             
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
if (clazz == null) {                                                                                   if (clazz == null) {                                                                                
throw new MBeanException(ex, sm.getString("managedMBean.cannotLoadClass", getClassName()));            throw new MBeanException(ex, sm.getString("managedMBean.cannotLoadClass", getClassName()));         
}                                                                                                      }                                                                                                   
try {                                                                                                  try {                                                                                               
// Stupid - this will set the default minfo first....                                                  // Stupid - this will set the default minfo first....                                               
mbean = (BaseModelMBean) clazz.getConstructor().newInstance();                                         mbean = (BaseModelMBean) clazz.getConstructor().newInstance();                                      
} catch (RuntimeOperationsException e) {                                                               } catch (RuntimeOperationsException e) {                                                            
throw e;                                                                                               throw e;                                                                                            
} catch (Exception e) {                                                                                } catch (Exception e) {                                                                             
throw new MBeanException(e, sm.getString("managedMBean.cannotInstantiateClass", getClassName()));      throw new MBeanException(e, sm.getString("managedMBean.cannotInstantiateClass", getClassName()));   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
mbean.setManagedBean(this);                                                                            mbean.setManagedBean(this);                                                                         
// Set the managed resource (if any)                                                                   // Set the managed resource (if any)                                                                
try {                                                                                                  try {                                                                                               
if (instance != null)                                                                                | if (instance != null) {                                                                             
mbean.setManagedResource(instance, "ObjectReference");                                                 mbean.setManagedResource(instance, "ObjectReference");                                              
                                                                                                     | }                                                                                                   
} catch (InstanceNotFoundException e) {                                                                } catch (InstanceNotFoundException e) {                                                             
throw e;                                                                                               throw e;                                                                                            
}                                                                                                      }                                                                                                   
return mbean;                                                                                          return mbean;                                                                                       
}                                                                                                      }                                                                                                   
