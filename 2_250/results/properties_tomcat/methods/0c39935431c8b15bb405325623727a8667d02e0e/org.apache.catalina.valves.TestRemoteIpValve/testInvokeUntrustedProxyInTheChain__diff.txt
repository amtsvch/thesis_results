@Test                                                                                                  @Test                                                                                               
public void testInvokeUntrustedProxyInTheChain() throws Exception {                                    public void testInvokeUntrustedProxyInTheChain() throws Exception {                                 
// PREPARE                                                                                             // PREPARE                                                                                          
RemoteIpValve remoteIpValve = new RemoteIpValve();                                                     RemoteIpValve remoteIpValve = new RemoteIpValve();                                                  
remoteIpValve.setInternalProxies("192\\.168\\.0\\.10|192\\.168\\.0\\.11");                             remoteIpValve.setInternalProxies("192\\.168\\.0\\.10|192\\.168\\.0\\.11");                          
remoteIpValve.setTrustedProxies("proxy1|proxy2|proxy3");                                               remoteIpValve.setTrustedProxies("proxy1|proxy2|proxy3");                                            
remoteIpValve.setRemoteIpHeader("x-forwarded-for");                                                    remoteIpValve.setRemoteIpHeader("x-forwarded-for");                                                 
remoteIpValve.setProxiesHeader("x-forwarded-by");                                                      remoteIpValve.setProxiesHeader("x-forwarded-by");                                                   
RemoteAddrAndHostTrackerValve remoteAddrAndHostTrackerValve = new RemoteAddrAndHostTrackerValve();     RemoteAddrAndHostTrackerValve remoteAddrAndHostTrackerValve = new RemoteAddrAndHostTrackerValve();  
remoteIpValve.setNext(remoteAddrAndHostTrackerValve);                                                  remoteIpValve.setNext(remoteAddrAndHostTrackerValve);                                               
Request request = new MockRequest();                                                                   Request request = new MockRequest();                                                                
request.setCoyoteRequest(new org.apache.coyote.Request());                                             request.setCoyoteRequest(new org.apache.coyote.Request());                                          
request.setRemoteAddr("192.168.0.10");                                                                 request.setRemoteAddr("192.168.0.10");                                                              
request.setRemoteHost("remote-host-original-value");                                                   request.setRemoteHost("remote-host-original-value");                                                
request.getCoyoteRequest().getMimeHeaders().addValue("x-forwarded-for").setString("140.211.11.130, p   request.getCoyoteRequest().getMimeHeaders().addValue("x-forwarded-for").setString("140.211.11.130, p
// TEST                                                                                                // TEST                                                                                             
remoteIpValve.invoke(request, null);                                                                   remoteIpValve.invoke(request, null);                                                                
// VERIFY                                                                                              // VERIFY                                                                                           
String actualXForwardedFor = remoteAddrAndHostTrackerValve.getForwardedFor();                          String actualXForwardedFor = remoteAddrAndHostTrackerValve.getForwardedFor();                       
Assert.assertEquals("ip/host before untrusted-proxy must appear in x-forwarded-for", "140.211.11.130 | Assert.assertEquals("ip/host before untrusted-proxy must appear in x-forwarded-for", "140.211.11.130
String actualXForwardedBy = remoteAddrAndHostTrackerValve.getForwardedBy();                            String actualXForwardedBy = remoteAddrAndHostTrackerValve.getForwardedBy();                         
Assert.assertEquals("ip/host after untrusted-proxy must appear in  x-forwarded-by", "proxy2", actual   Assert.assertEquals("ip/host after untrusted-proxy must appear in  x-forwarded-by", "proxy2", actual
String actualRemoteAddr = remoteAddrAndHostTrackerValve.getRemoteAddr();                               String actualRemoteAddr = remoteAddrAndHostTrackerValve.getRemoteAddr();                            
Assert.assertEquals("remoteAddr", "untrusted-proxy", actualRemoteAddr);                                Assert.assertEquals("remoteAddr", "untrusted-proxy", actualRemoteAddr);                             
String actualRemoteHost = remoteAddrAndHostTrackerValve.getRemoteHost();                               String actualRemoteHost = remoteAddrAndHostTrackerValve.getRemoteHost();                            
Assert.assertEquals("remoteHost", "untrusted-proxy", actualRemoteHost);                                Assert.assertEquals("remoteHost", "untrusted-proxy", actualRemoteHost);                             
String actualPostInvokeRemoteAddr = request.getRemoteAddr();                                           String actualPostInvokeRemoteAddr = request.getRemoteAddr();                                        
Assert.assertEquals("postInvoke remoteAddr", "192.168.0.10", actualPostInvokeRemoteAddr);              Assert.assertEquals("postInvoke remoteAddr", "192.168.0.10", actualPostInvokeRemoteAddr);           
String actualPostInvokeRemoteHost = request.getRemoteHost();                                           String actualPostInvokeRemoteHost = request.getRemoteHost();                                        
Assert.assertEquals("postInvoke remoteAddr", "remote-host-original-value", actualPostInvokeRemoteHos   Assert.assertEquals("postInvoke remoteAddr", "remote-host-original-value", actualPostInvokeRemoteHos
}                                                                                                      }                                                                                                   
