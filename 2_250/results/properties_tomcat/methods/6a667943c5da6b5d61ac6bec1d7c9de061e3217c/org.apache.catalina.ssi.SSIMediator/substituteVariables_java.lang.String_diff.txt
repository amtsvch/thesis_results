/**                                                                                                    /**                                                                                                 
* Applies variable substitution to the specified String and returns the                                * Applies variable substitution to the specified String and returns the                             
* new resolved string.                                                                                 * new resolved string.                                                                              
* @param val The value which should be checked                                                         * @param val The value which should be checked                                                      
* @return the value after variable substitution                                                        * @return the value after variable substitution                                                     
*/                                                                                                     */                                                                                                  
public String substituteVariables(String val) {                                                        public String substituteVariables(String val) {                                                     
// If it has no references or HTML entities then no work                                               // If it has no references or HTML entities then no work                                            
// need to be done                                                                                     // need to be done                                                                                  
if (val.indexOf('$') &lt; 0 && val.indexOf('&') &lt; 0)                                              | if (val.indexOf('$') &lt; 0 && val.indexOf('&') &lt; 0) {                                           
return val;                                                                                            return val;                                                                                         
                                                                                                     | }                                                                                                   
// HTML decoding                                                                                       // HTML decoding                                                                                    
val = val.replace("&lt;", "&lt;");                                                                     val = val.replace("&lt;", "&lt;");                                                                  
val = val.replace("&gt;", "&gt;");                                                                     val = val.replace("&gt;", "&gt;");                                                                  
val = val.replace("&quot;", "\"");                                                                     val = val.replace("&quot;", "\"");                                                                  
val = val.replace("&amp;", "&");                                                                       val = val.replace("&amp;", "&");                                                                    
StringBuilder sb = new StringBuilder(val);                                                             StringBuilder sb = new StringBuilder(val);                                                          
int charStart = sb.indexOf("&#");                                                                      int charStart = sb.indexOf("&#");                                                                   
while (charStart &gt; -1) {                                                                            while (charStart &gt; -1) {                                                                         
int charEnd = sb.indexOf(";", charStart);                                                              int charEnd = sb.indexOf(";", charStart);                                                           
if (charEnd &gt; -1) {                                                                                 if (charEnd &gt; -1) {                                                                              
char c = (char) Integer.parseInt(sb.substring(charStart + 2, charEnd));                                char c = (char) Integer.parseInt(sb.substring(charStart + 2, charEnd));                             
sb.delete(charStart, charEnd + 1);                                                                     sb.delete(charStart, charEnd + 1);                                                                  
sb.insert(charStart, c);                                                                               sb.insert(charStart, c);                                                                            
charStart = sb.indexOf("&#");                                                                          charStart = sb.indexOf("&#");                                                                       
} else {                                                                                               } else {                                                                                            
break;                                                                                                 break;                                                                                              
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
for (int i = 0; i &lt; sb.length(); ) {                                                                for (int i = 0; i &lt; sb.length(); ) {                                                             
// Find the next $                                                                                     // Find the next $                                                                                  
for (; i &lt; sb.length(); i++) {                                                                      for (; i &lt; sb.length(); i++) {                                                                   
if (sb.charAt(i) == '$') {                                                                             if (sb.charAt(i) == '$') {                                                                          
i++;                                                                                                   i++;                                                                                                
break;                                                                                                 break;                                                                                              
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
if (i == sb.length())                                                                                | if (i == sb.length()) {                                                                             
break;                                                                                                 break;                                                                                              
                                                                                                     | }                                                                                                   
// Check to see if the $ is escaped                                                                    // Check to see if the $ is escaped                                                                 
if (i &gt; 1 && sb.charAt(i - 2) == '\\') {                                                            if (i &gt; 1 && sb.charAt(i - 2) == '\\') {                                                         
sb.deleteCharAt(i - 2);                                                                                sb.deleteCharAt(i - 2);                                                                             
i--;                                                                                                   i--;                                                                                                
continue;                                                                                              continue;                                                                                           
}                                                                                                      }                                                                                                   
int nameStart = i;                                                                                     int nameStart = i;                                                                                  
int start = i - 1;                                                                                     int start = i - 1;                                                                                  
int end = -1;                                                                                          int end = -1;                                                                                       
int nameEnd = -1;                                                                                      int nameEnd = -1;                                                                                   
char endChar = ' ';                                                                                    char endChar = ' ';                                                                                 
// Check for {} wrapped var                                                                            // Check for {} wrapped var                                                                         
if (sb.charAt(i) == '{') {                                                                             if (sb.charAt(i) == '{') {                                                                          
nameStart++;                                                                                           nameStart++;                                                                                        
endChar = '}';                                                                                         endChar = '}';                                                                                      
}                                                                                                      }                                                                                                   
// Find the end of the var reference                                                                   // Find the end of the var reference                                                                
for (; i &lt; sb.length(); i++) {                                                                      for (; i &lt; sb.length(); i++) {                                                                   
if (sb.charAt(i) == endChar)                                                                         | if (sb.charAt(i) == endChar) {                                                                      
break;                                                                                                 break;                                                                                              
}                                                                                                      }                                                                                                   
                                                                                                     | }                                                                                                   
end = i;                                                                                               end = i;                                                                                            
nameEnd = end;                                                                                         nameEnd = end;                                                                                      
if (endChar == '}')                                                                                  | if (endChar == '}') {                                                                               
end++;                                                                                                 end++;                                                                                              
                                                                                                     | }                                                                                                   
// We should now have enough to extract the var name                                                   // We should now have enough to extract the var name                                                
String varName = sb.substring(nameStart, nameEnd);                                                     String varName = sb.substring(nameStart, nameEnd);                                                  
String value = getVariableValue(varName);                                                              String value = getVariableValue(varName);                                                           
if (value == null)                                                                                   | if (value == null) {                                                                                
value = "";                                                                                            value = "";                                                                                         
                                                                                                     | }                                                                                                   
// Replace the var name with its value                                                                 // Replace the var name with its value                                                              
sb.replace(start, end, value);                                                                         sb.replace(start, end, value);                                                                      
// Start searching for the next $ after the value                                                      // Start searching for the next $ after the value                                                   
// that was just substituted.                                                                          // that was just substituted.                                                                       
i = start + value.length();                                                                            i = start + value.length();                                                                         
}                                                                                                      }                                                                                                   
return sb.toString();                                                                                  return sb.toString();                                                                               
}                                                                                                      }                                                                                                   
