/**                                                                                                    /**                                                                                                 
* Set the appropriate context attribute for our class path.  This                                      * Set the appropriate context attribute for our class path.  This                                   
* is required only because Jasper depends on it.                                                       * is required only because Jasper depends on it.                                                    
*/                                                                                                     */                                                                                                  
private void setClassPath() {                                                                          private void setClassPath() {                                                                       
// Validate our current state information                                                              // Validate our current state information                                                           
if (context == null)                                                                                 | if (context == null) {                                                                              
return;                                                                                                return;                                                                                             
                                                                                                     | }                                                                                                   
ServletContext servletContext = context.getServletContext();                                           ServletContext servletContext = context.getServletContext();                                        
if (servletContext == null)                                                                          | if (servletContext == null) {                                                                       
return;                                                                                                return;                                                                                             
                                                                                                     | }                                                                                                   
StringBuilder classpath = new StringBuilder();                                                         StringBuilder classpath = new StringBuilder();                                                      
// Assemble the class path information from our class loader chain                                     // Assemble the class path information from our class loader chain                                  
ClassLoader loader = getClassLoader();                                                                 ClassLoader loader = getClassLoader();                                                              
if (delegate && loader != null) {                                                                      if (delegate && loader != null) {                                                                   
// Skip the webapp loader for now as delegation is enabled                                             // Skip the webapp loader for now as delegation is enabled                                          
loader = loader.getParent();                                                                           loader = loader.getParent();                                                                        
}                                                                                                      }                                                                                                   
while (loader != null) {                                                                               while (loader != null) {                                                                            
if (!buildClassPath(classpath, loader)) {                                                              if (!buildClassPath(classpath, loader)) {                                                           
break;                                                                                                 break;                                                                                              
}                                                                                                      }                                                                                                   
loader = loader.getParent();                                                                           loader = loader.getParent();                                                                        
}                                                                                                      }                                                                                                   
if (delegate) {                                                                                        if (delegate) {                                                                                     
// Delegation was enabled, go back and add the webapp paths                                            // Delegation was enabled, go back and add the webapp paths                                         
loader = getClassLoader();                                                                             loader = getClassLoader();                                                                          
if (loader != null) {                                                                                  if (loader != null) {                                                                               
buildClassPath(classpath, loader);                                                                     buildClassPath(classpath, loader);                                                                  
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
this.classpath = classpath.toString();                                                                 this.classpath = classpath.toString();                                                              
// Store the assembled class path as a servlet context attribute                                       // Store the assembled class path as a servlet context attribute                                    
servletContext.setAttribute(Globals.CLASS_PATH_ATTR, this.classpath);                                  servletContext.setAttribute(Globals.CLASS_PATH_ATTR, this.classpath);                               
}                                                                                                      }                                                                                                   
