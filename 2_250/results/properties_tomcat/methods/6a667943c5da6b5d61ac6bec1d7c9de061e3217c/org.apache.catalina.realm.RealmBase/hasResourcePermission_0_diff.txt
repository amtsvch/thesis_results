/**                                                                                                    /**                                                                                                 
* Perform access control based on the specified authorization constraint.                              * Perform access control based on the specified authorization constraint.                           
* Return &lt;code&gt;true&lt;/code&gt; if this constraint is satisfied and processing                  * Return &lt;code&gt;true&lt;/code&gt; if this constraint is satisfied and processing               
* should continue, or &lt;code&gt;false&lt;/code&gt; otherwise.                                        * should continue, or &lt;code&gt;false&lt;/code&gt; otherwise.                                     
*                                                                                                      *                                                                                                   
* @param request Request we are processing                                                             * @param request Request we are processing                                                          
* @param response Response we are creating                                                             * @param response Response we are creating                                                          
* @param constraints Security constraint we are enforcing                                              * @param constraints Security constraint we are enforcing                                           
* @param context The Context to which client of this class is attached.                                * @param context The Context to which client of this class is attached.                             
*                                                                                                      *                                                                                                   
* @exception IOException if an input/output error occurs                                               * @exception IOException if an input/output error occurs                                            
*/                                                                                                     */                                                                                                  
@Override                                                                                              @Override                                                                                           
public boolean hasResourcePermission(Request request, Response response, SecurityConstraint[] constr   public boolean hasResourcePermission(Request request, Response response, SecurityConstraint[] constr
if (constraints == null || constraints.length == 0)                                                  | if (constraints == null || constraints.length == 0) {                                               
return true;                                                                                           return true;                                                                                        
                                                                                                     | }                                                                                                   
// Which user principal have we already authenticated?                                                 // Which user principal have we already authenticated?                                              
Principal principal = request.getPrincipal();                                                          Principal principal = request.getPrincipal();                                                       
boolean status = false;                                                                                boolean status = false;                                                                             
boolean denyfromall = false;                                                                           boolean denyfromall = false;                                                                        
for (SecurityConstraint constraint : constraints) {                                                    for (SecurityConstraint constraint : constraints) {                                                 
String[] roles;                                                                                        String[] roles;                                                                                     
if (constraint.getAllRoles()) {                                                                        if (constraint.getAllRoles()) {                                                                     
// * means all roles defined in web.xml                                                                // * means all roles defined in web.xml                                                             
roles = request.getContext().findSecurityRoles();                                                      roles = request.getContext().findSecurityRoles();                                                   
} else {                                                                                               } else {                                                                                            
roles = constraint.findAuthRoles();                                                                    roles = constraint.findAuthRoles();                                                                 
}                                                                                                      }                                                                                                   
if (roles == null)                                                                                   | if (roles == null) {                                                                                
roles = new String[0];                                                                                 roles = new String[0];                                                                              
if (log.isDebugEnabled())                                                                            | }                                                                                                   
                                                                                                     | if (log.isDebugEnabled()) {                                                                         
log.debug("  Checking roles " + principal);                                                            log.debug("  Checking roles " + principal);                                                         
                                                                                                     | }                                                                                                   
if (constraint.getAuthenticatedUsers() && principal != null) {                                         if (constraint.getAuthenticatedUsers() && principal != null) {                                      
if (log.isDebugEnabled()) {                                                                            if (log.isDebugEnabled()) {                                                                         
log.debug("Passing all authenticated users");                                                          log.debug("Passing all authenticated users");                                                       
}                                                                                                      }                                                                                                   
status = true;                                                                                         status = true;                                                                                      
} else if (roles.length == 0 && !constraint.getAllRoles() && !constraint.getAuthenticatedUsers()) {    } else if (roles.length == 0 && !constraint.getAllRoles() && !constraint.getAuthenticatedUsers()) { 
if (constraint.getAuthConstraint()) {                                                                  if (constraint.getAuthConstraint()) {                                                               
if (log.isDebugEnabled()) {                                                                            if (log.isDebugEnabled()) {                                                                         
log.debug("No roles");                                                                                 log.debug("No roles");                                                                              
}                                                                                                      }                                                                                                   
// No listed roles means no access at all                                                              // No listed roles means no access at all                                                           
status = false;                                                                                        status = false;                                                                                     
denyfromall = true;                                                                                    denyfromall = true;                                                                                 
break;                                                                                                 break;                                                                                              
}                                                                                                      }                                                                                                   
if (log.isDebugEnabled()) {                                                                            if (log.isDebugEnabled()) {                                                                         
log.debug("Passing all access");                                                                       log.debug("Passing all access");                                                                    
}                                                                                                      }                                                                                                   
status = true;                                                                                         status = true;                                                                                      
} else if (principal == null) {                                                                        } else if (principal == null) {                                                                     
if (log.isDebugEnabled()) {                                                                            if (log.isDebugEnabled()) {                                                                         
log.debug("  No user authenticated, cannot grant access");                                             log.debug("  No user authenticated, cannot grant access");                                          
}                                                                                                      }                                                                                                   
} else {                                                                                               } else {                                                                                            
for (String role : roles) {                                                                            for (String role : roles) {                                                                         
if (hasRole(request.getWrapper(), principal, role)) {                                                  if (hasRole(request.getWrapper(), principal, role)) {                                               
status = true;                                                                                         status = true;                                                                                      
if (log.isDebugEnabled()) {                                                                            if (log.isDebugEnabled()) {                                                                         
log.debug("Role found:  " + role);                                                                     log.debug("Role found:  " + role);                                                                  
}                                                                                                      }                                                                                                   
} else if (log.isDebugEnabled()) {                                                                     } else if (log.isDebugEnabled()) {                                                                  
log.debug("No role found:  " + role);                                                                  log.debug("No role found:  " + role);                                                               
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
if (!denyfromall && allRolesMode != AllRolesMode.STRICT_MODE && !status && principal != null) {        if (!denyfromall && allRolesMode != AllRolesMode.STRICT_MODE && !status && principal != null) {     
if (log.isDebugEnabled()) {                                                                            if (log.isDebugEnabled()) {                                                                         
log.debug("Checking for all roles mode: " + allRolesMode);                                             log.debug("Checking for all roles mode: " + allRolesMode);                                          
}                                                                                                      }                                                                                                   
// Check for an all roles(role-name="*")                                                               // Check for an all roles(role-name="*")                                                            
for (SecurityConstraint constraint : constraints) {                                                    for (SecurityConstraint constraint : constraints) {                                                 
String[] roles;                                                                                        String[] roles;                                                                                     
// If the all roles mode exists, sets                                                                  // If the all roles mode exists, sets                                                               
if (constraint.getAllRoles()) {                                                                        if (constraint.getAllRoles()) {                                                                     
if (allRolesMode == AllRolesMode.AUTH_ONLY_MODE) {                                                     if (allRolesMode == AllRolesMode.AUTH_ONLY_MODE) {                                                  
if (log.isDebugEnabled()) {                                                                            if (log.isDebugEnabled()) {                                                                         
log.debug("Granting access for role-name=*, auth-only");                                               log.debug("Granting access for role-name=*, auth-only");                                            
}                                                                                                      }                                                                                                   
status = true;                                                                                         status = true;                                                                                      
break;                                                                                                 break;                                                                                              
}                                                                                                      }                                                                                                   
// For AllRolesMode.STRICT_AUTH_ONLY_MODE there must be zero roles                                     // For AllRolesMode.STRICT_AUTH_ONLY_MODE there must be zero roles                                  
roles = request.getContext().findSecurityRoles();                                                      roles = request.getContext().findSecurityRoles();                                                   
if (roles.length == 0 && allRolesMode == AllRolesMode.STRICT_AUTH_ONLY_MODE) {                         if (roles.length == 0 && allRolesMode == AllRolesMode.STRICT_AUTH_ONLY_MODE) {                      
if (log.isDebugEnabled()) {                                                                            if (log.isDebugEnabled()) {                                                                         
log.debug("Granting access for role-name=*, strict auth-only");                                        log.debug("Granting access for role-name=*, strict auth-only");                                     
}                                                                                                      }                                                                                                   
status = true;                                                                                         status = true;                                                                                      
break;                                                                                                 break;                                                                                              
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
// Return a "Forbidden" message denying access to this resource                                        // Return a "Forbidden" message denying access to this resource                                     
if (!status) {                                                                                         if (!status) {                                                                                      
response.sendError(HttpServletResponse.SC_FORBIDDEN, sm.getString("realmBase.forbidden"));             response.sendError(HttpServletResponse.SC_FORBIDDEN, sm.getString("realmBase.forbidden"));          
}                                                                                                      }                                                                                                   
return status;                                                                                         return status;                                                                                      
}                                                                                                      }                                                                                                   
